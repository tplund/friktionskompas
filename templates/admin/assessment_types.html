{% extends "admin/layout.html" %}

{% block title %}Målingstyper{% endblock %}

{% block content %}
<script>
function toggleQuestions(typeId) {
    const row = document.getElementById('questions-' + typeId);
    const arrow = document.getElementById('arrow-' + typeId);
    if (row.style.display === 'none') {
        row.style.display = 'table-row';
        arrow.textContent = '▲';
    } else {
        row.style.display = 'none';
        arrow.textContent = '▼';
    }
}
</script>
<div style="max-width: 1200px; margin: 0 auto;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <div>
            <h1 style="margin: 0; font-size: 1.75rem;">Målingstyper</h1>
            <p style="color: #666; margin-top: 5px;">Konfigurer hvilke tests og målinger der er tilgængelige i systemet</p>
        </div>
        <form action="{{ url_for('dev_tools.seed_assessment_types_route') }}" method="post" style="display: inline;">
            <button type="submit" style="background: #6b7280; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer;">
                Seed/Opdater typer
            </button>
        </form>
    </div>

    <!-- Assessment Types List -->
    <div style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 30px;">
        <div style="padding: 20px; border-bottom: 1px solid #e5e7eb;">
            <h2 style="margin: 0; font-size: 1.2rem;">Alle målingstyper</h2>
        </div>
        <div style="padding: 0;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #f9fafb;">
                        <th style="padding: 12px 20px; text-align: left; font-weight: 600; color: #6b7280; font-size: 0.85rem;">Type</th>
                        <th style="padding: 12px 20px; text-align: left; font-weight: 600; color: #6b7280; font-size: 0.85rem;">Beskrivelse</th>
                        <th style="padding: 12px 20px; text-align: center; font-weight: 600; color: #6b7280; font-size: 0.85rem;">Spørgsmål</th>
                        <th style="padding: 12px 20px; text-align: center; font-weight: 600; color: #6b7280; font-size: 0.85rem;">Varighed</th>
                        <th style="padding: 12px 20px; text-align: center; font-weight: 600; color: #6b7280; font-size: 0.85rem;">Type</th>
                        <th style="padding: 12px 20px; text-align: center; font-weight: 600; color: #6b7280; font-size: 0.85rem;">Storage</th>
                        <th style="padding: 12px 20px; text-align: center; font-weight: 600; color: #6b7280; font-size: 0.85rem;">Status</th>
                        <th style="padding: 12px 20px; text-align: center; font-weight: 600; color: #6b7280; font-size: 0.85rem;">Handling</th>
                    </tr>
                </thead>
                <tbody>
                    {% for at in assessment_types %}
                    <tr style="border-bottom: 1px solid #e5e7eb; {% if not at.is_active %}opacity: 0.5;{% endif %}" class="type-row" data-type-id="{{ at.id }}">
                        <td style="padding: 16px 20px;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span style="font-size: 1.5rem;">{{ at.icon }}</span>
                                <div>
                                    <div style="font-weight: 600;">{{ at.name }}</div>
                                    <div style="font-size: 0.8rem; color: #9ca3af; font-family: monospace;">{{ at.id }}</div>
                                </div>
                            </div>
                        </td>
                        <td style="padding: 16px 20px; color: #6b7280; font-size: 0.9rem; max-width: 300px;">
                            {{ at.description }}
                        </td>
                        <td style="padding: 16px 20px; text-align: center;">
                            <button onclick="toggleQuestions('{{ at.id }}')" style="background: #e5e7eb; padding: 4px 12px; border-radius: 12px; font-size: 0.85rem; border: none; cursor: pointer;">
                                {{ at.question_count }} <span id="arrow-{{ at.id }}">▼</span>
                            </button>
                        </td>
                        <td style="padding: 16px 20px; text-align: center; color: #6b7280;">
                            {{ at.duration_minutes }} min
                        </td>
                        <td style="padding: 16px 20px; text-align: center;">
                            {% if at.is_individual %}
                            <span style="background: #dbeafe; color: #1e40af; padding: 4px 12px; border-radius: 12px; font-size: 0.85rem;">
                                Individuel
                            </span>
                            {% else %}
                            <span style="background: #fef3c7; color: #92400e; padding: 4px 12px; border-radius: 12px; font-size: 0.85rem;">
                                Gruppe
                            </span>
                            {% endif %}
                        </td>
                        <td style="padding: 16px 20px; text-align: center;">
                            {% set storage = at.storage_mode or 'server' %}
                            {% if storage == 'local' %}
                            <span style="background: #ecfdf5; color: #065f46; padding: 4px 12px; border-radius: 12px; font-size: 0.85rem;" title="Data gemmes kun i brugerens browser (localStorage)">
                                Lokal
                            </span>
                            {% elif storage == 'both' %}
                            <span style="background: #f3e8ff; color: #7c3aed; padding: 4px 12px; border-radius: 12px; font-size: 0.85rem;" title="Bruger vælger: lokal eller server">
                                Valgfri
                            </span>
                            {% else %}
                            <span style="background: #dbeafe; color: #1e40af; padding: 4px 12px; border-radius: 12px; font-size: 0.85rem;" title="Data gemmes centralt på serveren">
                                Server
                            </span>
                            {% endif %}
                        </td>
                        <td style="padding: 16px 20px; text-align: center;">
                            {% if at.is_active %}
                            <span style="background: #d1fae5; color: #065f46; padding: 4px 12px; border-radius: 12px; font-size: 0.85rem;">
                                Aktiv
                            </span>
                            {% else %}
                            <span style="background: #fee2e2; color: #991b1b; padding: 4px 12px; border-radius: 12px; font-size: 0.85rem;">
                                Inaktiv
                            </span>
                            {% endif %}
                        </td>
                        <td style="padding: 16px 20px; text-align: center;">
                            <form action="{{ url_for('assessments.toggle_assessment_type', type_id=at.id) }}" method="post" style="display: inline;">
                                <button type="submit" style="background: {% if at.is_active %}#ef4444{% else %}#10b981{% endif %}; color: white; padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                                    {% if at.is_active %}Deaktiver{% else %}Aktiver{% endif %}
                                </button>
                            </form>
                        </td>
                    </tr>
                    <!-- Questions row (hidden by default) -->
                    <tr id="questions-{{ at.id }}" style="display: none; background: #f9fafb;">
                        <td colspan="8" style="padding: 0 20px 20px 20px;">
                            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px; margin-top: 10px;">
                                <h4 style="margin: 0 0 10px 0; font-size: 0.95rem; color: #374151;">Spørgsmål i denne type</h4>
                                {% if questions_by_type and questions_by_type.get(at.id) %}
                                <ul style="margin: 0; padding-left: 20px; font-size: 0.85rem; color: #6b7280; max-height: 300px; overflow-y: auto;">
                                    {% for q in questions_by_type.get(at.id, []) %}
                                    <li style="margin-bottom: 6px;">
                                        <span style="background: #f3f4f6; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; margin-right: 8px;">{{ q.field }}</span>
                                        {{ q.text_da }}
                                        {% if q.get('reverse_scored') %}<span style="color: #ef4444; font-size: 0.75rem;">(R)</span>{% endif %}
                                    </li>
                                    {% endfor %}
                                </ul>
                                {% else %}
                                <p style="margin: 0; color: #9ca3af; font-size: 0.85rem; font-style: italic;">Ingen spørgsmål konfigureret for denne type endnu.</p>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Presets Section -->
    <div style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
        <div style="padding: 20px; border-bottom: 1px solid #e5e7eb;">
            <h2 style="margin: 0; font-size: 1.2rem;">Presets</h2>
            <p style="color: #666; margin-top: 5px; font-size: 0.9rem;">Foruddefinerede kombinationer af målingstyper</p>
        </div>
        <div style="padding: 20px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
                {% for preset in presets %}
                <div style="border: 2px solid {% if preset.is_default %}#3b82f6{% else %}#e5e7eb{% endif %}; border-radius: 12px; padding: 20px; {% if preset.is_default %}background: #eff6ff;{% endif %}">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <h3 style="margin: 0; font-size: 1.1rem;">{{ preset.name }}</h3>
                        {% if preset.is_default %}
                        <span style="background: #3b82f6; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem;">
                            DEFAULT
                        </span>
                        {% endif %}
                    </div>
                    <p style="color: #6b7280; font-size: 0.9rem; margin-bottom: 15px;">{{ preset.description }}</p>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        {% for type in preset.types %}
                        <span style="background: #f3f4f6; padding: 4px 10px; border-radius: 8px; font-size: 0.85rem;">
                            {{ type.icon }} {{ type.name_da }}
                        </span>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Info section -->
    <div style="margin-top: 30px; padding: 20px; background: #f3f4f6; border-radius: 12px;">
        <h3 style="margin: 0 0 10px 0; font-size: 1rem;">Hvordan fungerer det?</h3>
        <ul style="margin: 0; padding-left: 20px; color: #6b7280; font-size: 0.9rem; line-height: 1.8;">
            <li><strong>Målingstyper</strong> definerer hvilke tests der findes i systemet - klik på antal spørgsmål for at se dem</li>
            <li><strong>Presets</strong> er foruddefinerede kombinationer som kan anvendes på kunder (read-only)</li>
            <li><strong>Default preset</strong> (markeret med blå) bruges automatisk for nye kunder og B2C brugere</li>
            <li>Kunder kan have <strong>custom konfiguration</strong> under Kunder & Brugere > Kunde > Målinger</li>
            <li>Domæner kan have <strong>egen konfiguration</strong> der overskriver kunde-config</li>
        </ul>

        <h4 style="margin: 20px 0 10px 0; font-size: 0.95rem;">Storage Modes (Privacy by Design)</h4>
        <ul style="margin: 0; padding-left: 20px; color: #6b7280; font-size: 0.9rem; line-height: 1.8;">
            <li><strong style="color: #065f46;">Lokal</strong> - Data gemmes KUN i brugerens browser (localStorage). Serveren beregner resultater men gemmer intet. Ideelt til B2C, parforhold-tests, ADHD-profiler.</li>
            <li><strong style="color: #1e40af;">Server</strong> - Data gemmes centralt på serveren. Standard for B2B organisationsmålinger hvor admin skal kunne se resultater.</li>
            <li><strong style="color: #7c3aed;">Valgfri</strong> - Bruger kan vælge om data skal gemmes lokalt eller på server.</li>
        </ul>
    </div>
</div>
{% endblock %}
