{% extends "admin/layout.html" %}

{% block title %}Min konto - Friktionskompasset{% endblock %}

{% block extra_css %}
<style>
    .account-header {
        background: linear-gradient(135deg, #1e3a5f 0%, #2d4a6f 100%);
        color: white;
        padding: 30px;
        border-radius: 12px;
        margin-bottom: 25px;
        display: flex;
        align-items: center;
        gap: 20px;
    }
    .account-avatar {
        width: 80px;
        height: 80px;
        background: rgba(255,255,255,0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
    }
    .account-info h1 {
        margin: 0 0 5px 0;
        font-size: 1.5rem;
    }
    .account-info p {
        margin: 0;
        opacity: 0.85;
    }
    .account-badge {
        background: rgba(255,255,255,0.2);
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        margin-left: 10px;
    }

    .section-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        border: 1px solid #e5e7eb;
        margin-bottom: 25px;
        overflow: hidden;
    }
    .section-header {
        padding: 20px 25px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .section-header h2 {
        margin: 0;
        font-size: 1.1rem;
        color: #1f2937;
    }
    .section-header .icon {
        font-size: 1.25rem;
    }
    .section-body {
        padding: 25px;
    }
    .section-subtitle {
        color: #6b7280;
        margin-bottom: 20px;
        font-size: 0.9rem;
    }

    /* Profile Form */
    .profile-form {
        max-width: 500px;
    }
    .form-group {
        margin-bottom: 20px;
    }
    .form-group label {
        display: block;
        font-weight: 500;
        color: #374151;
        margin-bottom: 6px;
        font-size: 0.9rem;
    }
    .form-group input {
        width: 100%;
        padding: 10px 14px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 0.95rem;
        transition: border-color 0.2s, box-shadow 0.2s;
    }
    .form-group input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    .form-group input:disabled {
        background: #f3f4f6;
        color: #6b7280;
        cursor: not-allowed;
    }
    .form-group .help-text {
        margin-top: 6px;
        font-size: 0.8rem;
        color: #6b7280;
    }
    .btn-save {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 0.95rem;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s;
    }
    .btn-save:hover {
        background: #2563eb;
    }
    .btn-save:disabled {
        background: #9ca3af;
        cursor: not-allowed;
    }
    .readonly-notice {
        background: #fef3c7;
        border: 1px solid #fcd34d;
        border-radius: 8px;
        padding: 12px 16px;
        margin-bottom: 20px;
        font-size: 0.9rem;
        color: #92400e;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .linked-accounts {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    .linked-account {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 15px 20px;
        background: #f9fafb;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
    }
    .provider-icon {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.25rem;
    }
    .provider-icon.microsoft { background: #00a4ef; }
    .provider-icon.google { background: #4285f4; }
    .provider-info {
        flex: 1;
    }
    .provider-name {
        font-weight: 600;
        color: #1f2937;
    }
    .provider-email {
        font-size: 0.85rem;
        color: #6b7280;
    }
    .provider-date {
        font-size: 0.8rem;
        color: #9ca3af;
    }
    .btn-unlink {
        background: #fee2e2;
        color: #dc2626;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 0.85rem;
        cursor: pointer;
        transition: background 0.2s;
    }
    .btn-unlink:hover {
        background: #fecaca;
    }

    .available-providers {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    .provider-option {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 15px 20px;
        background: white;
        border-radius: 8px;
        border: 2px dashed #e5e7eb;
        transition: all 0.2s;
    }
    .provider-option:hover {
        border-color: #3b82f6;
        background: #f0f9ff;
    }
    .btn-link-provider {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        transition: background 0.2s;
    }
    .btn-link-provider:hover {
        background: #2563eb;
        color: white;
    }

    .no-providers {
        text-align: center;
        padding: 30px;
        color: #6b7280;
    }
    .no-providers .icon {
        font-size: 3rem;
        margin-bottom: 15px;
        opacity: 0.5;
    }

    .security-note {
        background: #eff6ff;
        border: 1px solid #bfdbfe;
        border-radius: 8px;
        padding: 15px;
        margin-top: 20px;
        display: flex;
        align-items: flex-start;
        gap: 12px;
        font-size: 0.9rem;
        color: #1e40af;
    }
    .security-note .icon {
        font-size: 1.25rem;
        flex-shrink: 0;
    }

    /* Password change form */
    .password-form {
        max-width: 400px;
    }
    .password-form .form-group {
        margin-bottom: 16px;
    }
    .password-form .form-group label {
        display: block;
        font-weight: 500;
        color: #374151;
        margin-bottom: 6px;
        font-size: 0.9rem;
    }
    .password-form .form-group input {
        width: 100%;
        padding: 10px 14px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 0.95rem;
    }
    .password-form .form-group input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    .password-requirements {
        margin-top: 10px;
        font-size: 0.8rem;
        color: #6b7280;
    }
    .oauth-only-notice {
        background: #f3f4f6;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        color: #6b7280;
    }
    .oauth-only-notice .icon {
        font-size: 2rem;
        margin-bottom: 10px;
        opacity: 0.5;
    }

    .two-columns {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 25px;
    }
    @media (max-width: 900px) {
        .two-columns {
            grid-template-columns: 1fr;
        }
    }

    /* GDPR Section */
    .gdpr-actions {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    .btn-gdpr {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px 18px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        background: white;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
        color: #1f2937;
    }
    .btn-gdpr:hover {
        border-color: #3b82f6;
        background: #f0f9ff;
        color: #1f2937;
    }
    .btn-gdpr .icon {
        font-size: 1.5rem;
    }
    .btn-gdpr .text {
        flex: 1;
    }
    .btn-gdpr .text strong {
        display: block;
        margin-bottom: 3px;
    }
    .btn-gdpr .text small {
        color: #6b7280;
        font-size: 0.85rem;
    }
    .btn-delete {
        border-color: #fecaca;
        background: #fef2f2;
    }
    .btn-delete:hover {
        border-color: #dc2626;
        background: #fee2e2;
    }

    /* Delete Modal */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        z-index: 9999;
        align-items: center;
        justify-content: center;
    }
    .modal.active {
        display: flex;
    }
    .modal-content {
        background: white;
        border-radius: 16px;
        max-width: 500px;
        width: 90%;
        padding: 30px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    .modal-header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
    }
    .modal-header .icon {
        font-size: 2.5rem;
    }
    .modal-header h3 {
        margin: 0;
        color: #dc2626;
    }
    .modal-body {
        margin-bottom: 25px;
    }
    .modal-warning {
        background: #fef3c7;
        border-left: 4px solid #f59e0b;
        padding: 15px;
        margin: 15px 0;
        border-radius: 4px;
    }
    .modal-actions {
        display: flex;
        gap: 12px;
    }
    .btn-modal {
        flex: 1;
        padding: 12px 20px;
        border: none;
        border-radius: 8px;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }
    .btn-modal-cancel {
        background: #e5e7eb;
        color: #374151;
    }
    .btn-modal-cancel:hover {
        background: #d1d5db;
    }
    .btn-modal-confirm {
        background: #dc2626;
        color: white;
    }
    .btn-modal-confirm:hover {
        background: #b91c1c;
    }
</style>
{% endblock %}

{% block content %}
<div class="account-header">
    <div class="account-avatar">
        {{ session.user.name[0]|upper if session.user.name else '?' }}
    </div>
    <div class="account-info">
        <h1>
            {{ session.user.name }}
            <span class="account-badge">{{ session.user.role|upper }}</span>
        </h1>
        <p>{{ session.user.email }}</p>
        {% if session.user.customer_name %}
        <p style="opacity: 0.7; font-size: 0.9rem; margin-top: 5px;">{{ session.user.customer_name }}</p>
        {% endif %}
    </div>
</div>

<div class="two-columns">
    <div>
        <!-- Profile Information -->
        <div class="section-card">
            <div class="section-header">
                <span class="icon">üë§</span>
                <h2>Profilinformation</h2>
            </div>
            <div class="section-body">
                {% if not can_edit_profile %}
                <div class="readonly-notice">
                    <span>üîí</span>
                    <span>Din profil administreres af din organisation og kan ikke redigeres her.</span>
                </div>
                {% endif %}

                <form method="POST" class="profile-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="form-group">
                        <label for="name">Navn</label>
                        <input type="text" id="name" name="name"
                               value="{{ user_details.name or session.user.name }}"
                               {% if not can_edit_profile %}disabled{% endif %}
                               required>
                    </div>

                    <div class="form-group">
                        <label for="email">Email (login)</label>
                        <input type="email" id="email" name="email"
                               value="{{ user_details.email or session.user.email }}"
                               disabled>
                        <p class="help-text">Email-adressen bruges til at logge ind og kan ikke √¶ndres.</p>
                    </div>

                    <div class="form-group">
                        <label for="recovery_email">Recovery email (valgfri)</label>
                        <input type="email" id="recovery_email" name="recovery_email"
                               value="{{ user_details.recovery_email or '' }}"
                               {% if not can_edit_profile %}disabled{% endif %}
                               placeholder="En alternativ email til nulstilling af password">
                        <p class="help-text">Bruges hvis du mister adgang til din prim√¶re email.</p>
                    </div>

                    {% if can_edit_profile %}
                    <button type="submit" class="btn-save">Gem √¶ndringer</button>
                    {% endif %}
                </form>
            </div>
        </div>
    </div>

    <div>
        <!-- Linked OAuth Accounts -->
        <div class="section-card">
            <div class="section-header">
                <span class="icon">üîó</span>
                <h2>Login-metoder</h2>
            </div>
            <div class="section-body">
                <p class="section-subtitle">
                    Tilknyt flere login-metoder for nemmere adgang.
                </p>

                {% if linked_accounts %}
                <div class="linked-accounts">
                    {% for link in linked_accounts %}
                    <div class="linked-account">
                        <div class="provider-icon {{ link.provider }}">
                            {% if link.provider == 'microsoft' %}
                            <svg width="20" height="20" viewBox="0 0 21 21" fill="currentColor">
                                <path d="M0 0h10v10H0V0zm11 0h10v10H11V0zM0 11h10v10H0V11zm11 0h10v10H11V11z"/>
                            </svg>
                            {% elif link.provider == 'google' %}
                            G
                            {% endif %}
                        </div>
                        <div class="provider-info">
                            <div class="provider-name">{{ link.info.name }}</div>
                            {% if link.provider_email %}
                            <div class="provider-email">{{ link.provider_email }}</div>
                            {% endif %}
                            <div class="provider-date">Tilknyttet {{ link.created_at[:10] if link.created_at else 'ukendt' }}</div>
                        </div>
                        <form method="POST" action="{{ url_for('admin_unlink_oauth', provider=link.provider) }}"
                              onsubmit="return confirm('Er du sikker p√• at du vil fjerne {{ link.info.name }} fra din konto?');">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn-unlink">Fjern</button>
                        </form>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="no-providers">
                    <div class="icon">üîê</div>
                    <p>Du har ingen tilknyttede OAuth-konti.</p>
                </div>
                {% endif %}

                {% if available_providers %}
                <div class="available-providers" style="margin-top: 20px;">
                    {% for provider in available_providers %}
                    <div class="provider-option">
                        <div class="provider-icon {{ provider.id }}">
                            {% if provider.id == 'microsoft' %}
                            <svg width="20" height="20" viewBox="0 0 21 21" fill="currentColor">
                                <path d="M0 0h10v10H0V0zm11 0h10v10H11V0zM0 11h10v10H0V11zm11 0h10v10H11V11z"/>
                            </svg>
                            {% elif provider.id == 'google' %}
                            G
                            {% endif %}
                        </div>
                        <div class="provider-info" style="flex: 1;">
                            <div class="provider-name">{{ provider.info.name }}</div>
                            <div class="provider-email">Tilknyt din konto</div>
                        </div>
                        <a href="{{ url_for('admin_link_oauth', provider=provider.id) }}" class="btn-link-provider">
                            Tilknyt
                        </a>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Password Change -->
        <div class="section-card">
            <div class="section-header">
                <span class="icon">üîë</span>
                <h2>Skift password</h2>
            </div>
            <div class="section-body">
                {% if has_password %}
                <form method="POST" action="{{ url_for('admin_change_password') }}" class="password-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="form-group">
                        <label for="current_password">Nuv√¶rende password</label>
                        <input type="password" id="current_password" name="current_password" required>
                    </div>
                    <div class="form-group">
                        <label for="new_password">Nyt password</label>
                        <input type="password" id="new_password" name="new_password" required minlength="8">
                    </div>
                    <div class="form-group">
                        <label for="confirm_password">Bekr√¶ft nyt password</label>
                        <input type="password" id="confirm_password" name="confirm_password" required minlength="8">
                    </div>
                    <p class="password-requirements">Password skal v√¶re mindst 8 tegn</p>
                    <button type="submit" class="btn-save" style="margin-top: 15px;">Skift password</button>
                </form>
                {% else %}
                <div class="oauth-only-notice">
                    <div class="icon">üîê</div>
                    <p>Du logger ind via ekstern konto og har ikke et password at √¶ndre.</p>
                    <p style="font-size: 0.85rem; margin-top: 8px;">Du kan tilf√∏je email/password login ved at kontakte din administrator.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- GDPR Data & Privacy Section -->
<div class="section-card" style="margin-top: 25px;">
    <div class="section-header">
        <span class="icon">üîí</span>
        <h2>Data & Privatliv (GDPR)</h2>
    </div>
    <div class="section-body">
        <p class="section-subtitle">
            Administrer dine data i henhold til GDPR-rettigheder.
        </p>

        <div class="gdpr-actions">
            <!-- Export My Data -->
            <a href="{{ url_for('export_my_data') }}" class="btn-gdpr">
                <span class="icon">üì•</span>
                <div class="text">
                    <strong>Eksporter mine data</strong>
                    <small>Download alle dine personlige data som JSON-fil (max 1x per dag)</small>
                </div>
            </a>

            <!-- Delete Account -->
            <button type="button" class="btn-gdpr btn-delete" onclick="showDeleteModal()">
                <span class="icon">üóëÔ∏è</span>
                <div class="text">
                    <strong>Slet min konto</strong>
                    <small>Anmod om sletning af din konto (30 dages fortrydelsesret)</small>
                </div>
            </button>
        </div>

        <div class="security-note" style="margin-top: 20px;">
            <span class="icon">‚ÑπÔ∏è</span>
            <div>
                <strong>Om dine rettigheder:</strong><br>
                Du har ret til at f√• adgang til, rette, slette eller eksportere dine personlige data i henhold til GDPR.
                L√¶s mere i vores <a href="{{ url_for('public.privacy') }}" target="_blank" style="color: #2563eb;">privatlivspolitik</a>.
            </div>
        </div>
    </div>
</div>

<!-- Delete Account Modal -->
<div id="deleteModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span class="icon">‚ö†Ô∏è</span>
            <h3>Slet konto?</h3>
        </div>
        <div class="modal-body">
            <p><strong>Er du sikker p√• at du vil slette din konto?</strong></p>

            <div class="modal-warning">
                <strong>Hvad sker der:</strong>
                <ul style="margin: 10px 0 0 20px;">
                    <li>Din konto markeres til sletning</li>
                    <li>Du logges ud med det samme</li>
                    <li>Du har 30 dage til at fortryde</li>
                    <li>Efter 30 dage slettes dine data permanent</li>
                </ul>
            </div>

            <p style="margin-top: 15px; font-size: 0.9rem;">
                For at genaktivere din konto inden for 30-dages perioden, kontakt support@friktionskompasset.dk
            </p>

            <form method="POST" action="{{ url_for('delete_my_account') }}" id="deleteForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                {% if has_password %}
                <div class="form-group" style="margin-top: 20px;">
                    <label for="password_confirm">Bekr√¶ft med dit password:</label>
                    <input type="password" id="password_confirm" name="password_confirm"
                           required style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                </div>
                {% endif %}
            </form>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn-modal btn-modal-cancel" onclick="hideDeleteModal()">
                Annuller
            </button>
            <button type="button" class="btn-modal btn-modal-confirm" onclick="document.getElementById('deleteForm').submit()">
                Slet min konto
            </button>
        </div>
    </div>
</div>

<script>
function showDeleteModal() {
    document.getElementById('deleteModal').classList.add('active');
}

function hideDeleteModal() {
    document.getElementById('deleteModal').classList.remove('active');
}

// Close modal on escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        hideDeleteModal();
    }
});

// Close modal when clicking outside
document.getElementById('deleteModal').addEventListener('click', function(e) {
    if (e.target === this) {
        hideDeleteModal();
    }
});
</script>

{% endblock %}
