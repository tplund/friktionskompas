{% extends "admin/layout.html" %}

{% block title %}Friktionsm√•ling - {{ assessment.name }}{% endblock %}

{% block extra_css %}
<style>
    /* Mobile LANDSCAPE - when rotated sideways */
    @media (max-width: 896px) and (orientation: landscape) {
        .container-fluid {
            padding: 10px;
        }

        h1.h2 {
            font-size: 1.1rem;
            margin-bottom: 10px;
        }

        .field-card {
            padding: 12px !important;
            margin-bottom: 12px;
        }

        .field-header {
            font-size: 1rem !important;
            margin-bottom: 12px;
        }

        /* Make table more compact in landscape */
        table th, table td {
            padding: 6px 4px !important;
            font-size: 0.75rem;
        }

        .score-display {
            font-size: 1rem !important;
        }

        td .score-display {
            font-size: 0.9rem !important;
        }

        /* Smaller alert badges */
        .alert-badge {
            font-size: 0.6rem !important;
            padding: 2px 4px !important;
        }

        /* Compact SVG charts */
        svg {
            max-height: 250px;
        }

        /* Reduce legend spacing */
        div[style*="gap: 30px"] {
            gap: 15px !important;
        }

        /* Compact recommendation cards */
        .kkc-badge, .severity-badge {
            font-size: 0.65rem !important;
            padding: 3px 6px !important;
        }

        /* PDF button smaller */
        a[data-loading="Genererer PDF..."] {
            padding: 8px 15px !important;
            font-size: 0.8rem !important;
        }

        /* Row margins */
        .row.mb-4 {
            margin-bottom: 12px !important;
        }
    }

    /* Mobile responsive styles */
    @media (max-width: 767px) {
        .container-fluid {
            padding: 0;
        }

        h1.h2 {
            font-size: 1.25rem;
        }

        /* Header stacking */
        div[style*="justify-content: space-between"] {
            flex-direction: column !important;
            gap: 12px;
        }

        /* Tables scroll horizontally */
        table {
            display: block;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            font-size: 0.85rem;
        }

        table th, table td {
            padding: 10px 8px !important;
            white-space: nowrap;
        }

        .score-display {
            font-size: 1.2rem !important;
        }

        td .score-display {
            font-size: 1.1rem !important;
        }

        .field-card {
            padding: 15px !important;
        }

        .field-header {
            font-size: 1.2rem !important;
        }

        /* Alert badges */
        .alert-badge {
            font-size: 0.65rem !important;
            padding: 3px 6px !important;
        }

        /* SVG charts scale well, but legend needs adjustment */
        div[style*="display: flex"][style*="justify-content: center"][style*="gap: 30px"] {
            flex-direction: column !important;
            gap: 10px !important;
            align-items: flex-start !important;
        }

        /* Recommendations */
        .kkc-badge, .severity-badge {
            font-size: 0.7rem !important;
            padding: 4px 8px !important;
        }

        /* PDF button */
        a[data-loading="Genererer PDF..."] {
            width: 100%;
            text-align: center;
            display: block !important;
        }

        /* Alert cards */
        div[style*="border-left: 4px solid"] {
            padding: 12px !important;
        }

        /* Recommendations grid */
        div[style*="display: grid"][style*="gap: 20px"] {
            gap: 15px !important;
        }

        /* Legend row */
        div[style*="display: flex"][style*="gap: 20px"][style*="flex-wrap: wrap"] {
            gap: 12px !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 15px;">
                <div>
                    <h1 class="h2"><i data-lucide="bar-chart-3" style="width: 28px; height: 28px; display: inline-block; vertical-align: middle; margin-right: 8px;"></i>Friktionsm√•ling - {{ assessment.name }}</h1>
                    <p class="text-muted">{% if last_response_date %}Sidste besvarelse: {{ last_response_date }}{% endif %}</p>
                </div>
                <a href="/admin/assessment/{{ assessment.id }}/pdf"
                   style="display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; background: linear-gradient(135deg, var(--score-green) 0%, var(--score-green-600) 100%); color: white; text-decoration: none; border-radius: var(--radius-lg); font-weight: 600; font-size: 0.9rem;"
                   data-loading="Genererer PDF...">
                    <i data-lucide="file-text" style="width: 16px; height: 16px;"></i> Download PDF
                </a>
            </div>
        </div>
    </div>

    <!-- Tjek om der er leder-data -->
    {% set has_leader_data = breakdown.leader_assess.MENING.response_count > 0 or breakdown.leader_self.MENING.response_count > 0 %}

    <!-- Kompakt Tabel Sammenligning -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="field-card">
                <h3 class="field-header"><i data-lucide="bar-chart-3" style="width: 24px; height: 24px; display: inline-block; vertical-align: middle; margin-right: 8px;"></i>{% if has_leader_data %}Sammenligning{% else %}Resultater{% endif %}</h3>

                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: var(--gray-50);">
                            <th style="padding: var(--space-3); text-align: left; font-weight: var(--font-semibold); color: var(--gray-700);">Felt</th>
                            <th style="padding: var(--space-3); text-align: center; font-weight: var(--font-semibold); color: var(--gray-700);">Medarbejdere</th>
                            <th style="padding: var(--space-3); text-align: center; font-weight: var(--font-semibold); color: var(--gray-700);">Spredning (œÉ)</th>
                            {% if has_leader_data %}
                            <th style="padding: var(--space-3); text-align: center; font-weight: var(--font-semibold); color: var(--gray-700);">Leder vurderer</th>
                            <th style="padding: var(--space-3); text-align: center; font-weight: var(--font-semibold); color: var(--gray-700);">Leder selv</th>
                            {% endif %}
                            <th style="padding: var(--space-3); text-align: center; font-weight: var(--font-semibold); color: var(--gray-700);">Advarsler</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- SAMLET SCORE ROW -->
                        {% set emp_overall = (breakdown.employee.MENING.avg_score + breakdown.employee.TRYGHED.avg_score + breakdown.employee.KAN.avg_score + breakdown.employee.BESV√ÜR.avg_score) / 4 %}
                        {% set leader_assess_overall = (breakdown.leader_assess.MENING.avg_score + breakdown.leader_assess.TRYGHED.avg_score + breakdown.leader_assess.KAN.avg_score + breakdown.leader_assess.BESV√ÜR.avg_score) / 4 %}
                        {% set leader_self_overall = (breakdown.leader_self.MENING.avg_score + breakdown.leader_self.TRYGHED.avg_score + breakdown.leader_self.KAN.avg_score + breakdown.leader_self.BESV√ÜR.avg_score) / 4 %}
                        {% set gap_overall = (emp_overall - leader_assess_overall)|abs %}
                        {% set has_gap_overall = gap_overall >= 0.6 %}
                        {% set gap_overall_severity = 'kritisk' if gap_overall >= 1.0 else 'moderat' if gap_overall >= 0.6 else None %}
                        {% set is_blocked_overall = emp_overall < 3.5 and leader_self_overall < 3.5 %}
                        {% set avg_std_dev = (breakdown.employee.MENING.std_dev + breakdown.employee.TRYGHED.std_dev + breakdown.employee.KAN.std_dev + breakdown.employee.BESV√ÜR.std_dev) / 4 %}
                        {% set has_high_spread_overall = avg_std_dev > 1.0 %}

                        <tr style="border-bottom: 2px solid var(--gray-700); background: var(--gray-100); {% if has_gap_overall or is_blocked_overall or has_high_spread_overall %}background: var(--score-yellow-100);{% endif %}">
                            <td style="padding: var(--space-4); font-weight: var(--font-bold); color: var(--gray-900); font-size: var(--text-lg);">SAMLET</td>
                            <td style="padding: 16px; text-align: center;">
                                <span class="score-display {{ get_percent_class(emp_overall) }}" style="font-size: 1.75rem; font-weight: 800;">
                                    {{ "%.0f"|format(to_percent(emp_overall)) }}%
                                </span>
                                <div style="font-size: 0.75rem; color: #9ca3af; margin-top: 4px;">{{ "%.1f"|format(emp_overall) }}/5</div>
                            </td>
                            <td style="padding: 16px; text-align: center;">
                                <div style="font-size: 1.1rem; font-weight: 600; color: {% if has_high_spread_overall %}#dc2626{% elif avg_std_dev > 0.7 %}#f59e0b{% else %}#059669{% endif %};">
                                    {{ "%.2f"|format(avg_std_dev) }}
                                </div>
                                <div style="font-size: 0.75rem; color: #6b7280; margin-top: 4px;">
                                    {% if has_high_spread_overall %}H√∏j{% elif avg_std_dev > 0.7 %}Medium{% else %}Lav{% endif %}
                                </div>
                            </td>
                            {% if has_leader_data %}
                            <td style="padding: 16px; text-align: center;">
                                <span class="score-display {{ get_percent_class(leader_assess_overall) }}" style="font-size: 1.75rem; font-weight: 800;">
                                    {{ "%.0f"|format(to_percent(leader_assess_overall)) }}%
                                </span>
                                <div style="font-size: 0.75rem; color: #9ca3af; margin-top: 4px;">{{ "%.1f"|format(leader_assess_overall) }}/5</div>
                                {% if has_gap_overall %}
                                <div style="font-size: 0.7rem; color: #d97706; margin-top: 4px; font-weight: 600;">
                                    ‚Üï {{ "%.0f"|format(gap_overall * 20) }}% gap
                                </div>
                                {% endif %}
                            </td>
                            <td style="padding: 16px; text-align: center;">
                                <span class="score-display {{ get_percent_class(leader_self_overall) }}" style="font-size: 1.75rem; font-weight: 800;">
                                    {{ "%.0f"|format(to_percent(leader_self_overall)) }}%
                                </span>
                                <div style="font-size: 0.75rem; color: #9ca3af; margin-top: 4px;">{{ "%.1f"|format(leader_self_overall) }}/5</div>
                            </td>
                            {% endif %}
                            <td style="padding: 16px; text-align: center;">
                                <div style="display: flex; gap: 6px; justify-content: center; flex-wrap: wrap;">
                                    {% if has_gap_overall %}
                                    <span class="alert-badge alert-gap{% if gap_overall_severity == 'kritisk' %}-kritisk{% endif %}" title="{{ gap_overall_severity|title if gap_overall_severity else '' }} forskel mellem leder og medarbejdere ({{ '%.0f'|format(gap_overall * 20) }}%)"><i data-lucide="alert-triangle" style="width: 12px; height: 12px; margin-right: 4px;"></i>Forskel</span>
                                    {% endif %}
                                    {% if is_blocked_overall %}
                                    <span class="alert-badge alert-blocked" title="Leder blokeret - b√•de team og leder har friktioner"><i data-lucide="construction" style="width: 12px; height: 12px;"></i></span>
                                    {% endif %}
                                    {% if has_high_spread_overall %}
                                    <span class="alert-badge alert-spread" title="H√∏j spredning - meget uensartet oplevelse i teamet (œÉ={{ '%.2f'|format(avg_std_dev) }})"><i data-lucide="activity" style="width: 12px; height: 12px; margin-right: 4px;"></i>Spredning</span>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>

                        {% for field in ['TRYGHED', 'MENING', 'KAN', 'BESV√ÜR'] %}
                        {% set emp_score = breakdown.employee[field].avg_score %}
                        {% set leader_assess_score = breakdown.leader_assess[field].avg_score %}
                        {% set leader_self_score = breakdown.leader_self[field].avg_score %}
                        {% set gap = (emp_score - leader_assess_score)|abs %}
                        {% set has_gap = gap >= 0.6 %}
                        {% set gap_severity = breakdown.comparison[field].gap_severity %}
                        {% set is_blocked = emp_score < 3.5 and leader_self_score < 3.5 %}
                        {% set std_dev = breakdown.employee[field].std_dev %}
                        {% set spread = breakdown.employee[field].spread %}
                        {% set has_high_spread = spread == 'h√∏j' %}

                        <tr style="border-bottom: 1px solid var(--border-light); {% if has_gap or is_blocked or has_high_spread %}background: var(--score-yellow-100);{% endif %}">
                            <td style="padding: var(--space-4); font-weight: var(--font-semibold); color: var(--gray-700);">{{ field }}</td>
                            <td style="padding: 16px; text-align: center;">
                                <span class="score-display {{ get_percent_class(emp_score) }}" style="font-size: 1.5rem; font-weight: 700;">
                                    {{ "%.0f"|format(to_percent(emp_score)) }}%
                                </span>
                                <div style="font-size: 0.75rem; color: #9ca3af; margin-top: 4px;">{{ "%.1f"|format(emp_score) }}/5</div>
                            </td>
                            <td style="padding: 16px; text-align: center;">
                                <div style="font-size: 1rem; font-weight: 600; color: {% if spread == 'h√∏j' %}#dc2626{% elif spread == 'medium' %}#f59e0b{% else %}#059669{% endif %};">
                                    {{ "%.2f"|format(std_dev) }}
                                </div>
                                <div style="font-size: 0.75rem; color: #6b7280; margin-top: 4px;">{{ spread|title }}</div>
                            </td>
                            {% if has_leader_data %}
                            <td style="padding: 16px; text-align: center;">
                                <span class="score-display {{ get_percent_class(leader_assess_score) }}" style="font-size: 1.5rem; font-weight: 700;">
                                    {{ "%.0f"|format(to_percent(leader_assess_score)) }}%
                                </span>
                                <div style="font-size: 0.75rem; color: #9ca3af; margin-top: 4px;">{{ "%.1f"|format(leader_assess_score) }}/5</div>
                                {% if has_gap %}
                                <div style="font-size: 0.7rem; color: #d97706; margin-top: 4px; font-weight: 600;">
                                    ‚Üï {{ "%.0f"|format(gap * 20) }}% gap
                                </div>
                                {% endif %}
                            </td>
                            <td style="padding: 16px; text-align: center;">
                                <span class="score-display {{ get_percent_class(leader_self_score) }}" style="font-size: 1.5rem; font-weight: 700;">
                                    {{ "%.0f"|format(to_percent(leader_self_score)) }}%
                                </span>
                                <div style="font-size: 0.75rem; color: #9ca3af; margin-top: 4px;">{{ "%.1f"|format(leader_self_score) }}/5</div>
                            </td>
                            {% endif %}
                            <td style="padding: 16px; text-align: center;">
                                <div style="display: flex; gap: 6px; justify-content: center; flex-wrap: wrap;">
                                    {% if has_gap %}
                                    <span class="alert-badge alert-gap{% if gap_severity == 'kritisk' %}-kritisk{% endif %}" title="{{ gap_severity|title if gap_severity else '' }} forskel mellem leder og medarbejdere ({{ '%.0f'|format(gap * 20) }}%)"><i data-lucide="alert-triangle" style="width: 12px; height: 12px; margin-right: 4px;"></i>Forskel</span>
                                    {% endif %}
                                    {% if is_blocked %}
                                    <span class="alert-badge alert-blocked" title="Leder blokeret - b√•de team og leder har friktioner"><i data-lucide="construction" style="width: 12px; height: 12px;"></i></span>
                                    {% endif %}
                                    {% if has_high_spread %}
                                    <span class="alert-badge alert-spread" title="H√∏j spredning - uensartet oplevelse (œÉ={{ '%.2f'|format(std_dev) }})"><i data-lucide="activity" style="width: 12px; height: 12px; margin-right: 4px;"></i>Spredning</span>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

                <!-- Legend/explanation -->
                <div style="margin-top: var(--space-5); padding: var(--space-4); background: var(--gray-50); border-radius: var(--radius-lg); font-size: var(--text-sm); color: var(--gray-500);">
                    <strong><i data-lucide="lightbulb" style="width: 14px; height: 14px; display: inline-block; vertical-align: middle; margin-right: 4px;"></i> S√•dan l√¶ses procent:</strong> 100% = lav friktion (meget godt) ¬∑ 70%+ = gr√∏n zone ¬∑ 50-69% = gul zone ¬∑ Under 50% = r√∏d zone (h√∏j friktion)
                </div>

            </div>
        </div>
    </div>

    <!-- Friktionskompas (Radar Chart) -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="field-card">
                <h3 class="field-header"><i data-lucide="compass" style="width: 24px; height: 24px; display: inline-block; vertical-align: middle; margin-right: 8px;"></i>Friktionskompas</h3>

                <p style="font-size: 0.875rem; color: #6b7280; margin-bottom: 20px;">Bl√• polygon = medarbejdernes gennemsnit. Sm√• prikker = individuelle medarbejdere.{% if has_leader_data %} Orange stjerne = lederen selv.{% endif %}</p>

                <div style="display: flex; justify-content: center; align-items: center; padding: 20px;">
                    {% set emp_values = [
                        to_percent(breakdown.employee.MENING.avg_score),
                        to_percent(breakdown.employee.TRYGHED.avg_score),
                        to_percent(breakdown.employee.KAN.avg_score),
                        to_percent(breakdown.employee.BESV√ÜR.avg_score)
                    ] %}

                    <svg viewBox="-80 -60 760 760" style="max-width: 700px; width: 100%;">
                        <!-- Grid circles -->
                        <circle cx="300" cy="300" r="220" fill="none" stroke="#e5e7eb" stroke-width="2"/>
                        <circle cx="300" cy="300" r="165" fill="none" stroke="#e5e7eb" stroke-width="1"/>
                        <circle cx="300" cy="300" r="110" fill="none" stroke="#e5e7eb" stroke-width="1"/>
                        <circle cx="300" cy="300" r="55" fill="none" stroke="#e5e7eb" stroke-width="1"/>

                        <!-- Axes -->
                        <line x1="300" y1="300" x2="300" y2="80" stroke="#9ca3af" stroke-width="2"/>
                        <line x1="300" y1="300" x2="520" y2="300" stroke="#9ca3af" stroke-width="2"/>
                        <line x1="300" y1="300" x2="300" y2="520" stroke="#9ca3af" stroke-width="2"/>
                        <line x1="300" y1="300" x2="80" y2="300" stroke="#9ca3af" stroke-width="2"/>

                        <!-- Labels -->
                        <text x="300" y="40" text-anchor="middle" font-size="20" font-weight="bold" fill="#374151">MENING</text>
                        <text x="580" y="308" text-anchor="start" font-size="20" font-weight="bold" fill="#374151">TRYGHED</text>
                        <text x="300" y="580" text-anchor="middle" font-size="20" font-weight="bold" fill="#374151">KAN</text>
                        <text x="20" y="308" text-anchor="end" font-size="20" font-weight="bold" fill="#374151">BESV√ÜR</text>

                        <!-- Percentage labels -->
                        <text x="300" y="190" text-anchor="middle" font-size="13" fill="#6b7280">50%</text>
                        <text x="300" y="135" text-anchor="middle" font-size="13" fill="#6b7280">75%</text>

                        <!-- Individual employee polygons (light blue, transparent) -->
                        {% for emp in individual_scores.employees %}
                            {% set m = to_percent(emp.MENING) * 2.2 %}
                            {% set t = to_percent(emp.TRYGHED) * 2.2 %}
                            {% set k = to_percent(emp.KAN) * 2.2 %}
                            {% set b = to_percent(emp.BESV√ÜR) * 2.2 %}

                            {% set x1 = 300 %}
                            {% set y1 = 300 - m %}
                            {% set x2 = 300 + t %}
                            {% set y2 = 300 %}
                            {% set x3 = 300 %}
                            {% set y3 = 300 + k %}
                            {% set x4 = 300 - b %}
                            {% set y4 = 300 %}

                            <polygon points="{{ x1 }},{{ y1 }} {{ x2 }},{{ y2 }} {{ x3 }},{{ y3 }} {{ x4 }},{{ y4 }}"
                                     fill="none" stroke="#3b82f6" stroke-width="1" opacity="0.4"/>
                        {% endfor %}

                        <!-- Employee average polygon (darker blue, thicker line on top) -->
                        {% set emp_x1 = 300 %}
                        {% set emp_y1 = 300 - (emp_values[0] * 2.2) %}
                        {% set emp_x2 = 300 + (emp_values[1] * 2.2) %}
                        {% set emp_y2 = 300 %}
                        {% set emp_x3 = 300 %}
                        {% set emp_y3 = 300 + (emp_values[2] * 2.2) %}
                        {% set emp_x4 = 300 - (emp_values[3] * 2.2) %}
                        {% set emp_y4 = 300 %}
                        <polygon points="{{ emp_x1 }},{{ emp_y1 }} {{ emp_x2 }},{{ emp_y2 }} {{ emp_x3 }},{{ emp_y3 }} {{ emp_x4 }},{{ emp_y4 }}"
                                 fill="none" stroke="#3b82f6" stroke-width="3"/>

                        <!-- Average points on polygon (larger, on top) -->
                        <circle cx="{{ emp_x1 }}" cy="{{ emp_y1 }}" r="5" fill="#3b82f6" stroke="white" stroke-width="2"/>
                        <circle cx="{{ emp_x2 }}" cy="{{ emp_y2 }}" r="5" fill="#3b82f6" stroke="white" stroke-width="2"/>
                        <circle cx="{{ emp_x3 }}" cy="{{ emp_y3 }}" r="5" fill="#3b82f6" stroke="white" stroke-width="2"/>
                        <circle cx="{{ emp_x4 }}" cy="{{ emp_y4 }}" r="5" fill="#3b82f6" stroke="white" stroke-width="2"/>

                        <!-- Leader's own score (star marker) -->
                        {% if individual_scores.leader %}
                            {% set lm = to_percent(individual_scores.leader.MENING) * 2.2 %}
                            {% set lt = to_percent(individual_scores.leader.TRYGHED) * 2.2 %}
                            {% set lk = to_percent(individual_scores.leader.KAN) * 2.2 %}
                            {% set lb = to_percent(individual_scores.leader.BESV√ÜR) * 2.2 %}

                            <!-- Leader polygon connecting the stars -->
                            {% set leader_x1 = 300 %}
                            {% set leader_y1 = 300 - lm %}
                            {% set leader_x2 = 300 + lt %}
                            {% set leader_y2 = 300 %}
                            {% set leader_x3 = 300 %}
                            {% set leader_y3 = 300 + lk %}
                            {% set leader_x4 = 300 - lb %}
                            {% set leader_y4 = 300 %}
                            <polygon points="{{ leader_x1 }},{{ leader_y1 }} {{ leader_x2 }},{{ leader_y2 }} {{ leader_x3 }},{{ leader_y3 }} {{ leader_x4 }},{{ leader_y4 }}"
                                     fill="none" stroke="#f97316" stroke-width="2"/>

                            <!-- MENING axis (top) - star -->
                            <path d="M 300,{{ 300 - lm - 9 }} L {{ 300 + 2.8 }},{{ 300 - lm - 2.8 }} L {{ 300 + 9 }},{{ 300 - lm }} L {{ 300 + 2.8 }},{{ 300 - lm + 2.8 }} L 300,{{ 300 - lm + 9 }} L {{ 300 - 2.8 }},{{ 300 - lm + 2.8 }} L {{ 300 - 9 }},{{ 300 - lm }} L {{ 300 - 2.8 }},{{ 300 - lm - 2.8 }} Z"
                                  fill="#f97316" stroke="#fff" stroke-width="2"/>

                            <!-- TRYGHED axis (right) - star -->
                            <path d="M {{ 300 + lt + 9 }},300 L {{ 300 + lt + 2.8 }},{{ 300 + 2.8 }} L {{ 300 + lt }},{{ 300 + 9 }} L {{ 300 + lt - 2.8 }},{{ 300 + 2.8 }} L {{ 300 + lt - 9 }},300 L {{ 300 + lt - 2.8 }},{{ 300 - 2.8 }} L {{ 300 + lt }},{{ 300 - 9 }} L {{ 300 + lt + 2.8 }},{{ 300 - 2.8 }} Z"
                                  fill="#f97316" stroke="#fff" stroke-width="2"/>

                            <!-- KAN axis (bottom) - star -->
                            <path d="M 300,{{ 300 + lk + 9 }} L {{ 300 + 2.8 }},{{ 300 + lk + 2.8 }} L {{ 300 + 9 }},{{ 300 + lk }} L {{ 300 + 2.8 }},{{ 300 + lk - 2.8 }} L 300,{{ 300 + lk - 9 }} L {{ 300 - 2.8 }},{{ 300 + lk - 2.8 }} L {{ 300 - 9 }},{{ 300 + lk }} L {{ 300 - 2.8 }},{{ 300 + lk + 2.8 }} Z"
                                  fill="#f97316" stroke="#fff" stroke-width="2"/>

                            <!-- BESV√ÜR axis (left) - star -->
                            <path d="M {{ 300 - lb - 9 }},300 L {{ 300 - lb - 2.8 }},{{ 300 + 2.8 }} L {{ 300 - lb }},{{ 300 + 9 }} L {{ 300 - lb + 2.8 }},{{ 300 + 2.8 }} L {{ 300 - lb + 9 }},300 L {{ 300 - lb + 2.8 }},{{ 300 - 2.8 }} L {{ 300 - lb }},{{ 300 - 9 }} L {{ 300 - lb - 2.8 }},{{ 300 - 2.8 }} Z"
                                  fill="#f97316" stroke="#fff" stroke-width="2"/>
                        {% endif %}
                    </svg>
                </div>

                <!-- Legend -->
                <div style="display: flex; justify-content: center; gap: 30px; margin-top: 20px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 24px; height: 3px; background: #3b82f6;"></div>
                        <span style="font-size: 0.875rem; color: #374151;">Medarbejdere gennemsnit</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <svg width="20" height="20" viewBox="0 0 20 20">
                            <circle cx="10" cy="10" r="3" fill="#3b82f6" opacity="0.5"/>
                        </svg>
                        <span style="font-size: 0.875rem; color: #374151;">Individuelle ({{ individual_scores.employees|length }})</span>
                    </div>
                    {% if has_leader_data %}
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <svg width="20" height="20" viewBox="0 0 20 20">
                            <path d="M 10,2 L 12,8 L 18,10 L 12,12 L 10,18 L 8,12 L 2,10 L 8,8 Z" fill="#f97316" stroke="#fff" stroke-width="1"/>
                        </svg>
                        <span style="font-size: 0.875rem; color: #374151;">Leder selv</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Forskel-analyse (Slope Chart) - kun hvis der er lederdata -->
    {% if has_leader_data %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="field-card">
                <h3 class="field-header"><i data-lucide="git-compare" style="width: 24px; height: 24px; display: inline-block; vertical-align: middle; margin-right: 8px;"></i>Forskel</h3>
                <p style="font-size: 0.875rem; color: #6b7280; margin-bottom: 20px;">Viser forskellen mellem medarbejdernes oplevelse og lederens vurdering. Bl√• skygge viser spredning (¬±1œÉ) i medarbejdernes svar.</p>

                <svg viewBox="0 0 700 500" style="width: 100%; max-width: 700px;">
                    {% set y_spacing = 100 %}
                    {% set y_start = 80 %}

                    {% for field_idx, field in [('0', 'TRYGHED'), ('1', 'MENING'), ('2', 'KAN'), ('3', 'BESV√ÜR')] %}
                        {% set y = y_start + (field_idx|int * y_spacing) %}
                        {% set emp = to_percent(breakdown.employee[field].avg_score) %}
                        {% set leader_assess = to_percent(breakdown.leader_assess[field].avg_score) %}
                        {% set gap = (emp - leader_assess)|abs %}
                        {% set has_gap = gap > 20 %}
                        {% set std_dev = breakdown.employee[field].std_dev %}
                        {% set std_dev_pixels = std_dev * 112.5 %}

                        <!-- Field label -->
                        <text x="50" y="{{ y + 5 }}" font-size="16" font-weight="bold" fill="#374151">{{ field }}</text>

                        <!-- Scale line -->
                        <line x1="200" y1="{{ y }}" x2="650" y2="{{ y }}" stroke="#e5e7eb" stroke-width="2"/>

                        <!-- Reference marks -->
                        <line x1="200" y1="{{ y - 5 }}" x2="200" y2="{{ y + 5 }}" stroke="#9ca3af" stroke-width="2"/>
                        <text x="200" y="{{ y + 20 }}" text-anchor="middle" font-size="10" fill="#6b7280">0%</text>

                        <line x1="425" y1="{{ y - 5 }}" x2="425" y2="{{ y + 5 }}" stroke="#9ca3af" stroke-width="2"/>
                        <text x="425" y="{{ y + 20 }}" text-anchor="middle" font-size="10" fill="#6b7280">50%</text>

                        <line x1="650" y1="{{ y - 5 }}" x2="650" y2="{{ y + 5 }}" stroke="#9ca3af" stroke-width="2"/>
                        <text x="650" y="{{ y + 20 }}" text-anchor="middle" font-size="10" fill="#6b7280">100%</text>

                        <!-- Connection line (with color based on gap) -->
                        {% set emp_x = 200 + (emp * 4.5) %}
                        {% set leader_x = 200 + (leader_assess * 4.5) %}
                        <line x1="{{ emp_x }}" y1="{{ y }}" x2="{{ leader_x }}" y2="{{ y }}"
                              stroke="{% if has_gap %}#ef4444{% else %}#10b981{% endif %}"
                              stroke-width="{% if has_gap %}4{% else %}2{% endif %}"
                              opacity="0.6"/>

                        <!-- Employee spread/error bar (¬±1 std dev) -->
                        {% set emp_x_minus = emp_x - std_dev_pixels %}
                        {% set emp_x_plus = emp_x + std_dev_pixels %}
                        <!-- Spread range indicator (light blue shaded area) -->
                        <rect x="{{ emp_x_minus }}" y="{{ y - 12 }}" width="{{ std_dev_pixels * 2 }}" height="24"
                              fill="#3b82f6" opacity="0.15" rx="3"/>
                        <!-- Spread error bar lines -->
                        <line x1="{{ emp_x_minus }}" y1="{{ y - 10 }}" x2="{{ emp_x_minus }}" y2="{{ y + 10 }}"
                              stroke="#3b82f6" stroke-width="2" opacity="0.5"/>
                        <line x1="{{ emp_x_plus }}" y1="{{ y - 10 }}" x2="{{ emp_x_plus }}" y2="{{ y + 10 }}"
                              stroke="#3b82f6" stroke-width="2" opacity="0.5"/>

                        <!-- Employee point (blue) - drawn on top -->
                        <circle cx="{{ emp_x }}" cy="{{ y }}" r="8" fill="#3b82f6" stroke="white" stroke-width="2"/>
                        <text x="{{ emp_x }}" y="{{ y - 15 }}" text-anchor="middle" font-size="12" font-weight="bold" fill="#3b82f6">{{ "%.0f"|format(emp) }}%</text>

                        <!-- Leader assess point (orange) -->
                        <circle cx="{{ leader_x }}" cy="{{ y }}" r="8" fill="#fb923c" stroke="white" stroke-width="2"/>
                        <text x="{{ leader_x }}" y="{{ y - 15 }}" text-anchor="middle" font-size="12" font-weight="bold" fill="#fb923c">{{ "%.0f"|format(leader_assess) }}%</text>

                        <!-- Forskel indicator -->
                        {% if has_gap %}
                        <text x="{{ (emp_x + leader_x) / 2 }}" y="{{ y + 30 }}" text-anchor="middle" font-size="11" font-weight="bold" fill="#ef4444">Forskel: {{ "%.0f"|format(gap) }}%</text>
                        {% endif %}
                    {% endfor %}

                    <!-- Legend -->
                    <circle cx="80" cy="460" r="6" fill="#3b82f6"/>
                    <text x="92" y="465" font-size="12" fill="#374151">Medarbejdere</text>

                    <circle cx="220" cy="460" r="6" fill="#fb923c"/>
                    <text x="232" y="465" font-size="12" fill="#374151">Leder vurderer</text>

                    <!-- Spread indicator in legend -->
                    <rect x="360" y="454" width="30" height="12" fill="#3b82f6" opacity="0.15" rx="2"/>
                    <line x1="360" y1="456" x2="360" y2="464" stroke="#3b82f6" stroke-width="1.5" opacity="0.5"/>
                    <line x1="390" y1="456" x2="390" y2="464" stroke="#3b82f6" stroke-width="1.5" opacity="0.5"/>
                    <text x="396" y="465" font-size="12" fill="#374151">Spredning (¬±1œÉ)</text>
                </svg>
            </div>
        </div>
    </div>
    {% endif %}

    <style>
        /* Score display colors */
        .score-display {
            transition: var(--transition-default);
        }
        .score-display.score-high {
            color: var(--score-green-700);
        }
        .score-display.score-medium {
            color: var(--score-yellow-700);
        }
        .score-display.score-low {
            color: var(--score-red-700);
        }

        /* Alert badges */
        .alert-badge {
            display: inline-flex;
            align-items: center;
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-sm);
            font-size: var(--text-xs);
            font-weight: var(--font-semibold);
            white-space: nowrap;
        }
        .alert-badge.alert-gap {
            background: var(--score-yellow-100);
            color: var(--score-yellow-800);
            border: 1px solid var(--score-yellow-400);
        }
        .alert-badge.alert-gap-kritisk {
            background: var(--score-red-100);
            color: var(--score-red-700);
            border: 1px solid var(--score-red-400);
        }
        .alert-badge.alert-blocked {
            background: var(--score-red-100);
            color: var(--score-red-700);
            border: 1px solid var(--score-red-400);
        }
        .alert-badge.alert-spread {
            background: var(--color-primary-100);
            color: var(--color-primary-700);
            border: 1px solid var(--color-primary-400);
        }

        /* KKC Styling */
        .kkc-badge {
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-md);
            font-weight: var(--font-bold);
            font-size: var(--text-sm);
            background: linear-gradient(135deg, var(--color-primary-500) 0%, var(--color-primary-700) 100%);
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: var(--shadow-primary);
        }
        .severity-badge {
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-md);
            font-weight: var(--font-semibold);
            font-size: var(--text-sm);
        }
        .severity-badge.h√∏j { background: var(--score-red); color: white; }
        .severity-badge.medium { background: var(--score-yellow); color: white; }
        .severity-badge.lav { background: var(--score-green); color: white; }

        /* Visual bars */
        .visual-bar-container {
            margin-bottom: var(--space-8);
        }
        .visual-bar-label {
            font-weight: var(--font-semibold);
            margin-bottom: var(--space-2-5);
            color: var(--gray-700);
            font-size: var(--text-lg);
        }
        .visual-bar-group {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }
        .visual-bar-item {
            display: flex;
            align-items: center;
            gap: var(--space-4);
        }
        .visual-bar-item-label {
            min-width: 180px;
            font-size: var(--text-sm);
            color: var(--gray-500);
        }
        .visual-bar-bg {
            flex: 1;
            height: 32px;
            background: var(--gray-200);
            border-radius: var(--radius-sm);
            position: relative;
            overflow: hidden;
        }
        .visual-bar-fill {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: var(--space-2-5);
            color: white;
            font-weight: var(--font-semibold);
            font-size: 14px;
        }
        .visual-bar-fill.employee {
            background: linear-gradient(90deg, var(--color-primary-500) 0%, var(--color-primary-600) 100%);
        }
        .visual-bar-fill.leader-assess {
            background: linear-gradient(90deg, var(--score-yellow-400) 0%, var(--score-yellow-500) 100%);
        }
        .visual-bar-fill.leader-self {
            background: linear-gradient(90deg, var(--accent-purple) 0%, var(--accent-purple-600) 100%);
        }

        .field-card {
            background: var(--bg-primary);
            border-radius: var(--radius-xl);
            padding: var(--space-8);
            margin-bottom: var(--space-5);
            box-shadow: var(--shadow-sm);
        }
        .field-header {
            color: var(--gray-900);
            margin-bottom: var(--space-5);
            font-size: var(--text-2xl);
            font-weight: var(--font-semibold);
            font-family: var(--font-heading);
        }
    </style>

    <!-- Advarsler & Fund -->
    {% if alerts and alerts|length > 0 %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="field-card" style="border-left: 5px solid #ef4444;">
                <h3 class="field-header"><i data-lucide="alert-triangle" style="width: 24px; height: 24px; display: inline-block; vertical-align: middle; margin-right: 8px; color: var(--score-red);"></i>Advarsler & Fund</h3>
                <p style="font-size: 0.875rem; color: #6b7280; margin-bottom: 25px;">Vigtige fund og anbefalinger baseret p√• analysen</p>

                <div style="display: flex; flex-direction: column; gap: 15px;">
                    {% for alert in alerts %}
                    <div style="background: {% if alert.severity == 'kritisk' %}#fee2e2{% elif alert.severity == 'moderat' %}#fef3c7{% else %}#dbeafe{% endif %};
                                border-left: 4px solid {% if alert.severity == 'kritisk' %}#dc2626{% elif alert.severity == 'moderat' %}#f59e0b{% else %}#3b82f6{% endif %};
                                padding: 20px;
                                border-radius: 8px;">

                        <!-- Header -->
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 1.5rem;">{{ alert.icon }}</span>
                                <div>
                                    <h4 style="margin: 0; color: {% if alert.severity == 'kritisk' %}#991b1b{% elif alert.severity == 'moderat' %}#92400e{% else %}#1e40af{% endif %}; font-size: 1.1rem;">
                                        {{ alert.title }}
                                    </h4>
                                    {% if alert.field %}
                                    <div style="font-size: 0.75rem; color: #6b7280; margin-top: 4px;">
                                        Omr√•de: <strong>{{ alert.field }}</strong>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <span style="background: {% if alert.severity == 'kritisk' %}#dc2626{% elif alert.severity == 'moderat' %}#f59e0b{% else %}#3b82f6{% endif %};
                                         color: white;
                                         padding: 4px 12px;
                                         border-radius: 6px;
                                         font-size: 0.75rem;
                                         font-weight: 600;
                                         text-transform: uppercase;">
                                {{ alert.severity }}
                            </span>
                        </div>

                        <!-- Description -->
                        <p style="margin: 0 0 12px 0; color: {% if alert.severity == 'kritisk' %}#7f1d1d{% elif alert.severity == 'moderat' %}#78350f{% else %}#1e3a8a{% endif %}; line-height: 1.5;">
                            {{ alert.description }}
                        </p>

                        <!-- Recommendation -->
                        {% if alert.recommendation %}
                        <div style="background: {% if alert.severity == 'kritisk' %}#fef2f2{% elif alert.severity == 'moderat' %}#fffbeb{% else %}#eff6ff{% endif %};
                                    padding: 12px;
                                    border-radius: 6px;
                                    margin-top: 10px;">
                            <strong style="color: {% if alert.severity == 'kritisk' %}#991b1b{% elif alert.severity == 'moderat' %}#92400e{% else %}#1e40af{% endif %}; font-size: 0.875rem;">
                                Anbefaling:
                            </strong>
                            <p style="margin: 5px 0 0 0; color: {% if alert.severity == 'kritisk' %}#7f1d1d{% elif alert.severity == 'moderat' %}#78350f{% else %}#1e3a8a{% endif %}; font-size: 0.875rem; line-height: 1.5;">
                                {{ alert.recommendation }}
                            </p>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>

                <!-- Severity Legend -->
                <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                    <div style="display: flex; gap: 20px; flex-wrap: wrap; font-size: 0.875rem; color: #6b7280;">
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <div style="width: 16px; height: 16px; background: #dc2626; border-radius: 3px;"></div>
                            <span>Kritisk - kr√¶ver √∏jeblikkelig handling</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <div style="width: 16px; height: 16px; background: #f59e0b; border-radius: 3px;"></div>
                            <span>Moderat - b√∏r adresseres snart</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <div style="width: 16px; height: 16px; background: #3b82f6; border-radius: 3px;"></div>
                            <span>Info - v√¶rd at v√¶re opm√¶rksom p√•</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- KKC Anbefalinger -->
    {% if start_here %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="field-card" style="border-left: 5px solid #667eea; background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);">

                {% if start_here.single %}
                    <!-- SINGLE RECOMMENDATION -->
                    {% set rec = start_here.primary %}
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">
                        <h2 style="color: #667eea; margin: 0;">Start Her: {{ rec.field }}</h2>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <span class="kkc-badge">KKC: {{ rec.kkc_element }}</span>
                            <span class="severity-badge {{ rec.severity }}">{{ rec.severity_emoji }} {{ rec.severity|title }} friktion ¬∑ {{ rec.score }}/5</span>
                            {% if rec.spread == 'h√∏j' %}
                            <span class="alert-badge alert-spread">üìä H√∏j spredning ({{ "%.2f"|format(rec.std_dev) }})</span>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Prioriteringsforklaring -->
                    <div style="background: #f0f9ff; border-left: 4px solid #3b82f6; padding: 12px 15px; margin-bottom: 20px; border-radius: 4px;">
                        <strong style="color: #1e40af;">Hvorfor denne prioritering?</strong>
                        <p style="margin: 8px 0 0 0; color: #1e3a8a; font-size: 0.875rem;">
                            {{ start_here.reason }}
                        </p>
                    </div>

                    <div style="margin: 20px 0;">
                        <h4 style="color: #4b5563; margin-bottom: 10px;">Problemet</h4>
                        <p style="color: #6b7280; line-height: 1.6;">{{ rec.problem }}</p>
                    </div>

                    <div style="margin: 20px 0;">
                        <h4 style="color: #4b5563; margin-bottom: 15px;">Konkrete handlinger</h4>
                        <ol style="margin: 0; padding-left: 20px; color: #374151;">
                            {% for action in rec.actions %}
                            <li style="margin-bottom: 10px; line-height: 1.6;">{{ action }}</li>
                            {% endfor %}
                        </ol>
                    </div>

                    <div style="margin: 20px 0;">
                        <h4 style="color: #4b5563; margin-bottom: 10px;">Opf√∏lgning</h4>
                        <p style="color: #6b7280; line-height: 1.6;">{{ rec.follow_up }}</p>
                    </div>

                    <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); border-left: 4px solid #667eea; padding: 15px; border-radius: 6px; margin-top: 20px;">
                        <p style="color: #4b5563; font-style: italic; margin: 0;">{{ rec.kkc_reference }}</p>
                    </div>

                {% else %}
                    <!-- MULTIPLE RECOMMENDATIONS -->
                    <h2 style="color: #667eea; margin: 0 0 20px 0;">Prioriterede Anbefalinger</h2>

                    <!-- Forklaring -->
                    <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 12px 15px; margin-bottom: 20px; border-radius: 4px;">
                        <strong style="color: #92400e;">Flere ligev√¶rdige friktioner</strong>
                        <p style="margin: 8px 0 0 0; color: #92400e; font-size: 0.875rem;">
                            {{ start_here.reason }}
                        </p>
                    </div>

                    <!-- Liste af anbefalinger -->
                    <div style="display: grid; gap: 20px;">
                        {% for rec in start_here.recommendations %}
                        <div style="background: white; border: 2px solid #e5e7eb; border-radius: 8px; padding: 20px; {% if rec.spread == 'h√∏j' %}border-color: #3b82f6;{% endif %}">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                <h3 style="color: #1f2937; margin: 0; font-size: 1.3rem;">{{ loop.index }}. {{ rec.field }}</h3>
                                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    <span class="kkc-badge" style="font-size: 0.75rem; padding: 4px 8px;">{{ rec.kkc_element }}</span>
                                    <span class="severity-badge {{ rec.severity }}" style="font-size: 0.75rem; padding: 4px 8px;">{{ rec.severity_emoji }} {{ rec.score }}/5</span>
                                    {% if rec.spread == 'h√∏j' %}
                                    <span class="alert-badge alert-spread" style="font-size: 0.7rem; padding: 3px 6px;">üìä œÉ={{ "%.2f"|format(rec.std_dev) }}</span>
                                    {% endif %}
                                </div>
                            </div>

                            <p style="color: #6b7280; font-size: 0.875rem; margin: 0 0 10px 0;"><strong>Problem:</strong> {{ rec.problem }}</p>

                            <details style="margin-top: 10px;">
                                <summary style="cursor: pointer; color: #667eea; font-weight: 600; font-size: 0.875rem;">Se konkrete handlinger ‚ñº</summary>
                                <ol style="margin: 10px 0 0 0; padding-left: 20px; color: #374151; font-size: 0.875rem;">
                                    {% for action in rec.actions %}
                                    <li style="margin-bottom: 8px;">{{ action }}</li>
                                    {% endfor %}
                                </ol>
                                <p style="margin: 10px 0 0 0; color: #6b7280; font-size: 0.875rem;"><strong>Opf√∏lgning:</strong> {{ rec.follow_up }}</p>
                            </details>
                        </div>
                        {% endfor %}
                    </div>

                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Free Text Comments -->
    {% if free_text_comments and free_text_comments|length > 0 %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="field-card">
                <h3 class="field-header"><i data-lucide="message-square" style="width: 24px; height: 24px; display: inline-block; vertical-align: middle; margin-right: 8px;"></i>Fritekst Kommentarer</h3>
                <p class="text-muted mb-3">Anonymiserede kommentarer fra respondenter</p>

                <div style="display: flex; flex-direction: column; gap: 15px;">
                    {% for comment in free_text_comments %}
                    <div style="background: #f9fafb; padding: 15px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                        <div style="color: #6b7280; font-size: 0.875rem; margin-bottom: 5px;">
                            Respondent {{ comment.respondent_type|upper }}
                        </div>
                        <div style="color: #1f2937;">{{ comment.comment }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

</div>
{% endblock %}
