{% extends "admin/layout.html" %}

{% block title %}Email Templates - Friktionskompasset{% endblock %}

{% block content %}
<div class="container" style="max-width: 1200px;">
    <h1>Email Templates</h1>
    <p class="subtitle">Tilpas email-tekster per kunde. Hvis ingen kunde-template findes, bruges standard-templaten.</p>

    <!-- Customer Selector -->
    <div class="card">
        <h3>Vælg kunde</h3>
        <select id="customerSelect" class="form-control" onchange="loadTemplates()">
            <option value="">-- Standard templates --</option>
            {% for customer in customers %}
            <option value="{{ customer.id }}" {% if selected_customer == customer.id %}selected{% endif %}>
                {{ customer.name }}
            </option>
            {% endfor %}
        </select>
    </div>

    <!-- Template Tabs -->
    <div class="tabs" style="margin-top: 2rem;">
        <button class="tab active" data-template="invitation">Invitation</button>
        <button class="tab" data-template="reminder">Reminder</button>
        <button class="tab" data-template="profil_invitation">Profil Invitation</button>
    </div>

    <!-- Template Editor -->
    <div class="card template-editor">
        <div class="form-group">
            <label>Emne (Subject)</label>
            <input type="text" id="templateSubject" class="form-control" placeholder="Email emne...">
            <small class="help-text">Variabler: {assessment_name}, {sender_name}, {responses_count}</small>
        </div>

        <div class="form-group">
            <label>HTML Indhold</label>
            <textarea id="templateHtml" class="form-control code-editor" rows="20"></textarea>
            <small class="help-text">
                Variabler: {survey_url}, {sender_name}, {assessment_name}, {primary_color},
                {header_text}, {anonymity_text}, {closing_text}, {contact_email}
            </small>
        </div>

        <div class="form-group">
            <label>Plain Text (valgfrit)</label>
            <textarea id="templateText" class="form-control" rows="10"></textarea>
        </div>

        <div class="button-group">
            <button class="btn btn-primary" onclick="saveTemplate()">Gem Template</button>
            <button class="btn btn-secondary" onclick="resetToDefault()">Nulstil til Standard</button>
            <button class="btn btn-secondary" onclick="previewTemplate()">Forhåndsvis</button>
        </div>
    </div>

    <!-- Preview Modal -->
    <div id="previewModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>Email Forhåndsvisning</h3>
                <button class="close-btn" onclick="closePreview()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="previewContent"></div>
            </div>
        </div>
    </div>
</div>

<style>
.tabs {
    display: flex;
    gap: 0.5rem;
    border-bottom: 2px solid #e5e7eb;
    padding-bottom: 0;
}

.tab {
    padding: 0.75rem 1.5rem;
    border: none;
    background: transparent;
    cursor: pointer;
    font-size: 0.95rem;
    color: #6b7280;
    border-bottom: 2px solid transparent;
    margin-bottom: -2px;
}

.tab:hover {
    color: #374151;
}

.tab.active {
    color: #3b82f6;
    border-bottom-color: #3b82f6;
    font-weight: 500;
}

.template-editor {
    margin-top: 1.5rem;
}

.code-editor {
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.875rem;
    line-height: 1.5;
    background: #1f2937;
    color: #e5e7eb;
    border-radius: 6px;
    padding: 1rem;
    width: 100%;
    min-width: 100%;
}

.form-control {
    width: 100%;
}

.form-group {
    margin-bottom: 1.5rem;
}

.template-editor {
    width: 100%;
}

.help-text {
    color: #9ca3af;
    font-size: 0.8rem;
    margin-top: 0.25rem;
}

.button-group {
    display: flex;
    gap: 1rem;
    margin-top: 1.5rem;
}

.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-content {
    background: white;
    border-radius: 8px;
    width: 90%;
    max-height: 90vh;
    overflow: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #e5e7eb;
}

.modal-body {
    padding: 1.5rem;
}

.close-btn {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #6b7280;
}

.subtitle {
    color: #6b7280;
    margin-bottom: 2rem;
}
</style>

<script>
const defaultTemplates = {{ default_templates | tojson | safe }};
let currentTemplateType = 'invitation';
let customerTemplates = {};

// Tab switching
document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', function() {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        currentTemplateType = this.dataset.template;
        loadTemplate();
    });
});

function loadTemplates() {
    const customerId = document.getElementById('customerSelect').value;
    if (customerId) {
        fetch(`/api/email-templates?customer_id=${customerId}`)
            .then(r => r.json())
            .then(data => {
                customerTemplates = {};
                data.forEach(t => {
                    customerTemplates[t.template_type] = t;
                });
                loadTemplate();
            });
    } else {
        customerTemplates = {};
        loadTemplate();
    }
}

function loadTemplate() {
    const template = customerTemplates[currentTemplateType] || defaultTemplates[currentTemplateType];
    if (template) {
        document.getElementById('templateSubject').value = template.subject || '';
        document.getElementById('templateHtml').value = template.html_content || template.html || '';
        document.getElementById('templateText').value = template.text_content || template.text || '';
    }
}

function saveTemplate() {
    const customerId = document.getElementById('customerSelect').value;
    if (!customerId) {
        alert('Vælg en kunde først for at gemme en tilpasset template.');
        return;
    }

    fetch('/api/email-templates', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            customer_id: parseInt(customerId),
            template_type: currentTemplateType,
            subject: document.getElementById('templateSubject').value,
            html_content: document.getElementById('templateHtml').value,
            text_content: document.getElementById('templateText').value
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert('Template gemt!');
            loadTemplates();
        } else {
            alert('Fejl: ' + (data.error || 'Ukendt fejl'));
        }
    });
}

function resetToDefault() {
    const template = defaultTemplates[currentTemplateType];
    if (template) {
        document.getElementById('templateSubject').value = template.subject;
        document.getElementById('templateHtml').value = template.html;
        document.getElementById('templateText').value = template.text;
    }
}

function previewTemplate() {
    const html = document.getElementById('templateHtml').value
        .replace(/{survey_url}/g, 'https://example.com/survey/abc123')
        .replace(/{sender_name}/g, 'HR Afdelingen')
        .replace(/{assessment_name}/g, 'Test Måling')
        .replace(/{primary_color}/g, '#3b82f6')
        .replace(/{header_text}/g, 'Hjælp os med at fjerne friktioner')
        .replace(/{anonymity_text}/g, '• Ingen kan se hvem der skrev hvad<br>• Resultater vises kun når mindst 5 har svaret<br>• Dit link virker kun én gang')
        .replace(/{closing_text}/g, 'Dine ærlige svar hjælper os med at fjerne barrierer og gøre hverdagen bedre.')
        .replace(/{contact_email}/g, 'support@example.com')
        .replace(/{responses_count}/g, '3')
        .replace(/{greeting}/g, 'Hej!')
        .replace(/{context_text}/g, 'en personlig indsigt i hvordan du håndterer pres og friktion');

    document.getElementById('previewContent').innerHTML = html;
    document.getElementById('previewModal').style.display = 'flex';
}

function closePreview() {
    document.getElementById('previewModal').style.display = 'none';
}

// Initial load
loadTemplate();
</script>
{% endblock %}
