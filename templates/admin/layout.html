<!DOCTYPE html>
<html lang="{{ get_user_language() }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <title>{% block title %}Admin{% endblock %} - {{ domain_config.branding_company_name or 'Friktionskompasset' }}</title>
    <style>
        :root {
            --primary-color: {{ domain_config.branding_primary_color or '#3b82f6' }};
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #f9fafb;
        }

        /* Navigation */
        .nav {
            background: #1f2937;
            color: white;
            padding: 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
        }
        .nav-brand {
            font-size: 1.25rem;
            font-weight: 600;
            padding: 20px 0;
        }

        /* Top menu - View switcher */
        .view-switcher {
            display: flex;
            gap: 5px;
            list-style: none;
            background: rgba(0,0,0,0.2);
            padding: 5px;
            border-radius: 8px;
        }
        .view-switcher a {
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            padding: 10px 20px;
            display: block;
            transition: all 0.2s;
            border-radius: 6px;
            font-weight: 500;
        }
        .view-switcher a:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        .view-switcher a.active {
            background: #3b82f6;
            color: white;
        }

        /* Submenu */
        .submenu {
            background: #374151;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .submenu-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }
        .submenu-links {
            display: flex;
            gap: 5px;
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .submenu-links a {
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            padding: 12px 15px;
            display: block;
            transition: all 0.2s;
            font-size: 0.875rem;
        }
        .submenu-links a:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        .submenu-links a.active {
            background: rgba(59, 130, 246, 0.3);
            color: white;
            border-bottom: 2px solid #3b82f6;
        }

        /* Dropdown menu i submenu */
        .submenu-dropdown {
            position: relative;
        }
        .submenu-dropdown .dropdown-toggle {
            cursor: pointer;
        }
        .submenu-dropdown .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: #1f2937;
            border-radius: 0 0 6px 6px;
            min-width: 180px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 100;
            list-style: none;
            padding: 5px 0;
        }
        .submenu-dropdown:hover .dropdown-menu {
            display: block;
        }
        .submenu-dropdown .dropdown-menu a {
            padding: 10px 15px;
            display: block;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            font-size: 0.85rem;
        }
        .submenu-dropdown .dropdown-menu a:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        .submenu-dropdown .dropdown-menu a.active {
            background: rgba(59, 130, 246, 0.3);
            border-bottom: none;
        }

        .nav-user {
            display: flex;
            align-items: center;
            gap: 8px;
            color: rgba(255,255,255,0.8);
            font-size: 0.875rem;
        }
        .nav-user-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .user-badge {
            display: inline-block;
            background: #3b82f6;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .nav-divider {
            width: 1px;
            height: 20px;
            background: rgba(255,255,255,0.2);
            margin: 0 8px;
        }
        .nav-actions {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .nav-actions a {
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            padding: 6px 12px;
            border-radius: 6px;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 0.85rem;
        }
        .nav-actions a:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        /* Language dropdown */
        .lang-dropdown {
            position: relative;
        }
        .lang-dropdown-toggle {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            padding: 5px 10px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        .lang-dropdown-toggle:hover {
            background: rgba(255,255,255,0.15);
            border-color: rgba(255,255,255,0.3);
        }
        .lang-dropdown-toggle .flag {
            font-size: 1.1rem;
            line-height: 1;
        }
        .lang-dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 4px;
            background: #1f2937;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            min-width: 120px;
            z-index: 1000;
            overflow: hidden;
        }
        .lang-dropdown:hover .lang-dropdown-menu {
            display: block;
        }
        .lang-dropdown-menu a {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: all 0.2s;
            font-size: 0.85rem;
        }
        .lang-dropdown-menu a:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        .lang-dropdown-menu a.active {
            background: rgba(59, 130, 246, 0.3);
            color: white;
        }
        .lang-dropdown-menu .flag {
            font-size: 1.1rem;
        }

        /* Customer switcher */
        .customer-switcher {
            margin-left: 20px;
        }
        .customer-switcher select {
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .customer-switcher select:hover {
            background: rgba(255,255,255,0.15);
            border-color: rgba(255,255,255,0.5);
        }
        .customer-switcher select option,
        .role-switcher select option {
            background: #1f2937;
            color: white;
        }

        /* Main content */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Toast notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 400px;
        }
        .toast {
            padding: 16px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease-out;
            cursor: pointer;
            transition: opacity 0.3s, transform 0.3s;
        }
        .toast:hover {
            transform: translateX(-5px);
        }
        .toast.hiding {
            opacity: 0;
            transform: translateX(100%);
        }
        .toast-icon {
            font-size: 1.2rem;
            flex-shrink: 0;
        }
        .toast-message {
            flex: 1;
            font-size: 0.95rem;
            line-height: 1.4;
        }
        .toast-close {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            opacity: 0.6;
            padding: 0;
            line-height: 1;
        }
        .toast-close:hover { opacity: 1; }
        .toast.success { background: #d1fae5; color: #065f46; border-left: 4px solid #10b981; }
        .toast.error { background: #fee2e2; color: #991b1b; border-left: 4px solid #ef4444; }
        .toast.warning { background: #fef3c7; color: #92400e; border-left: 4px solid #f59e0b; }
        .toast.info { background: #dbeafe; color: #1e40af; border-left: 4px solid #3b82f6; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* ========================================
           MOBILE RESPONSIVE STYLES
           ======================================== */

        /* Hamburger menu button */
        .hamburger-btn {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 8px;
            line-height: 1;
        }
        .hamburger-btn span {
            display: block;
            width: 22px;
            height: 2px;
            background: white;
            margin: 5px 0;
            transition: 0.3s;
        }
        .hamburger-btn.active span:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }
        .hamburger-btn.active span:nth-child(2) {
            opacity: 0;
        }
        .hamburger-btn.active span:nth-child(3) {
            transform: rotate(-45deg) translate(5px, -5px);
        }

        /* Mobile menu overlay */
        .mobile-menu {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #1f2937;
            z-index: 9999;
            overflow-y: auto;
            padding: 60px 20px 20px;
        }
        .mobile-menu.active {
            display: block;
        }
        .mobile-menu-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            padding: 5px 10px;
        }
        .mobile-menu-section {
            margin-bottom: 25px;
        }
        .mobile-menu-section-title {
            color: rgba(255,255,255,0.5);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
            padding-left: 10px;
        }
        .mobile-menu a {
            display: block;
            color: white;
            text-decoration: none;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 4px;
            transition: background 0.2s;
        }
        .mobile-menu a:hover,
        .mobile-menu a.active {
            background: rgba(59, 130, 246, 0.3);
        }
        .mobile-menu select {
            width: 100%;
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 1rem;
            margin-bottom: 10px;
        }
        .mobile-menu select option {
            background: #1f2937;
            color: white;
        }
        .mobile-user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .mobile-user-info .user-badge {
            background: #3b82f6;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
        }

        /* Mobile: < 768px */
        @media (max-width: 767px) {
            .nav-container {
                padding: 10px 15px;
            }

            .nav-brand {
                font-size: 0.95rem;
                padding: 5px 0;
            }

            /* Show hamburger, hide everything else in nav */
            .hamburger-btn {
                display: block;
            }
            .view-switcher,
            .customer-switcher,
            .role-switcher,
            .nav-user {
                display: none !important;
            }

            /* Hide entire submenu on mobile - use hamburger instead */
            .submenu {
                display: none;
            }

            /* Main content */
            .container {
                padding: 15px 10px;
            }

            /* Toast notifications */
            .toast-container {
                left: 10px;
                right: 10px;
                max-width: none;
            }
        }

        /* Mobile LANDSCAPE - more compact layout */
        @media (max-width: 896px) and (orientation: landscape) {
            .nav-container {
                padding: 5px 15px;
            }
            .nav-brand {
                font-size: 0.9rem;
                padding: 3px 0;
            }
            .nav {
                min-height: auto;
            }
            .container {
                padding: 10px;
            }
            /* Smaller hamburger in landscape */
            .hamburger-btn {
                padding: 5px;
            }
            .hamburger-btn span {
                width: 18px;
                height: 2px;
                margin: 4px 0;
            }
        }

        /* Tablet: 768px - 1024px */
        @media (min-width: 768px) and (max-width: 1024px) {
            .nav-container {
                padding: 0 15px;
            }

            .view-switcher a {
                padding: 8px 12px;
                font-size: 0.9rem;
            }

            .submenu-links a {
                padding: 10px 12px;
                font-size: 0.85rem;
            }

            .container {
                padding: 15px;
            }
        }

        /* Utility classes for responsive hiding */
        @media (max-width: 767px) {
            .hide-mobile { display: none !important; }
        }
        @media (min-width: 768px) {
            .hide-desktop { display: none !important; }
        }

        /* Form validation styles */
        .form-group.has-error input,
        .form-group.has-error select,
        .form-group.has-error textarea {
            border-color: #ef4444 !important;
            background-color: #fef2f2;
        }
        .form-group.has-error input:focus,
        .form-group.has-error select:focus,
        .form-group.has-error textarea:focus {
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
        }
        .form-error {
            color: #dc2626;
            font-size: 0.8rem;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .form-error::before {
            content: '‚ö†';
        }
        .form-group.has-success input,
        .form-group.has-success select {
            border-color: #22c55e !important;
        }
        .input-hint {
            color: #6b7280;
            font-size: 0.8rem;
            margin-top: 4px;
        }
        /* Skip link for accessibility */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: #3b82f6;
            color: white;
            padding: 8px 16px;
            z-index: 10000;
            text-decoration: none;
            font-weight: 600;
            border-radius: 0 0 4px 0;
        }
        .skip-link:focus {
            top: 0;
        }

        /* Focus styling for accessibility */
        a:focus,
        button:focus,
        input:focus,
        select:focus,
        textarea:focus,
        [tabindex]:focus {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }
        /* Remove outline for mouse users, keep for keyboard */
        a:focus:not(:focus-visible),
        button:focus:not(:focus-visible) {
            outline: none;
        }
        a:focus-visible,
        button:focus-visible,
        input:focus-visible,
        select:focus-visible {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }
    </style>
    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- Skip link for keyboard users -->
    <a href="#main-content" class="skip-link">Spring til hovedindhold</a>

    <nav class="nav" role="navigation" aria-label="Hovednavigation">
        <div class="nav-container">
            <div class="nav-brand">
                {% if domain_config and domain_config.branding_logo_url %}
                <img src="{{ domain_config.branding_logo_url }}" alt="{{ domain_config.branding_company_name or 'Logo' }}" style="height: 28px; margin-right: 8px; vertical-align: middle;">
                {% else %}
                üè¢
                {% endif %}
                {{ domain_config.branding_company_name if domain_config and domain_config.branding_company_name else 'Friktionskompasset' }}
            </div>

            {% if session.user.role == 'admin' and not session.impersonating %}
            <!-- View switcher - kun for admin -->
            <ul class="view-switcher">
                <li><a href="/admin/view/user" {% if session.get('view_mode') == 'user' %}class="active"{% endif %}>üë§ Brugervisning</a></li>
                <li><a href="/admin/view/manager" {% if session.get('view_mode') == 'manager' %}class="active"{% endif %}>üëî Ledervisning</a></li>
                <li><a href="/admin/view/admin" {% if session.get('view_mode', 'admin') == 'admin' %}class="active"{% endif %}>üîß Adminvisning</a></li>
            </ul>
            {% endif %}

            {% if session.user.role == 'superadmin' %}
            <!-- Customer switcher dropdown - KUN for superadmin -->
            <div class="customer-switcher">
                <select id="customerSelect" onchange="switchCustomer(this.value)">
                    <option value="">üåç Alle kunder</option>
                    {% for customer in customers %}
                    <option value="{{ customer.id }}"
                        {% if session.customer_filter == customer.id %}selected
                        {% elif current_filter == customer.id %}selected
                        {% endif %}>
                        {{ customer.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}

            {% if session.user.role == 'superadmin' %}
            <!-- Role simulation for superadmin -->
            <div class="role-switcher" style="margin-left: 10px;">
                <select id="roleSelect" onchange="switchRole(this.value)" style="padding: 6px 12px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: white; font-size: 0.85rem; cursor: pointer;">
                    <option value="" {% if not session.simulated_role %}selected{% endif %}>üëë Superadmin</option>
                    <option value="admin" {% if session.simulated_role == 'admin' %}selected{% endif %}>üîß Admin</option>
                    <option value="manager" {% if session.simulated_role == 'manager' %}selected{% endif %}>üëî Manager</option>
                </select>
            </div>
            {% endif %}

            <div class="nav-user">
                <!-- User info -->
                <div class="nav-user-info">
                    <span>{{ session.user.name }}</span>
                    {% if is_simulating %}
                    <span class="user-badge" style="background: #f59e0b;">{{ simulated_role|upper }} (sim)</span>
                    {% else %}
                    <span class="user-badge">{{ session.user.role|upper }}</span>
                    {% endif %}
                    {% if session.user.customer_name %}
                    <span style="opacity: 0.6;">{{ session.user.customer_name }}</span>
                    {% endif %}
                    {% if session.impersonating %}
                    <a href="/admin/stop-impersonate" style="background: #ef4444; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; text-decoration: none;">‚Üê Tilbage</a>
                    {% endif %}
                </div>

                <div class="nav-divider"></div>

                <!-- Actions: Language, Account, Logout -->
                <div class="nav-actions">
                    <!-- Language dropdown with flags -->
                    {% set current_lang = get_user_language() %}
                    <div class="lang-dropdown">
                        <div class="lang-dropdown-toggle">
                            <span class="flag">{% if current_lang == 'da' %}üá©üá∞{% else %}üá¨üáß{% endif %}</span>
                            <span>{{ current_lang|upper }}</span>
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M6 9l6 6 6-6"/>
                            </svg>
                        </div>
                        <div class="lang-dropdown-menu">
                            <a href="/set-language/da" {% if current_lang == 'da' %}class="active"{% endif %}>
                                <span class="flag">üá©üá∞</span> Dansk
                            </a>
                            <a href="/set-language/en" {% if current_lang == 'en' %}class="active"{% endif %}>
                                <span class="flag">üá¨üáß</span> English
                            </a>
                        </div>
                    </div>

                    <a href="/admin/my-account">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                        {{ t('nav.my_account') }}
                    </a>

                    <a href="/logout">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                            <polyline points="16,17 21,12 16,7"></polyline>
                            <line x1="21" y1="12" x2="9" y2="12"></line>
                        </svg>
                        {{ t('nav.logout') }}
                    </a>
                </div>
            </div>

            <!-- Hamburger button (mobile only) -->
            <button class="hamburger-btn" onclick="toggleMobileMenu()" aria-label="Menu">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </nav>

    <!-- Mobile Menu Overlay -->
    <div id="mobileMenu" class="mobile-menu">
        <button class="mobile-menu-close" onclick="toggleMobileMenu()">√ó</button>

        <!-- User info -->
        <div class="mobile-user-info">
            <span>{{ session.user.name }}</span>
            {% if is_simulating %}
            <span class="user-badge" style="background: #f59e0b;">{{ simulated_role|upper }}</span>
            {% else %}
            <span class="user-badge">{{ session.user.role|upper }}</span>
            {% endif %}
        </div>

        {% if session.user.role == 'superadmin' %}
        <!-- Superadmin controls -->
        <div class="mobile-menu-section">
            <div class="mobile-menu-section-title">Superadmin</div>
            <select onchange="switchCustomer(this.value)">
                <option value="">üåç Alle kunder</option>
                {% for customer in customers %}
                <option value="{{ customer.id }}" {% if session.customer_filter == customer.id %}selected{% endif %}>
                    {{ customer.name }}
                </option>
                {% endfor %}
            </select>
            <select onchange="switchRole(this.value)">
                <option value="" {% if not session.simulated_role %}selected{% endif %}>üëë Superadmin</option>
                <option value="admin" {% if session.simulated_role == 'admin' %}selected{% endif %}>üîß Admin</option>
                <option value="manager" {% if session.simulated_role == 'manager' %}selected{% endif %}>üëî Manager</option>
            </select>
        </div>
        {% endif %}

        <!-- Navigation -->
        <div class="mobile-menu-section">
            <div class="mobile-menu-section-title">Navigation</div>
            <a href="/admin" {% if request.path == '/admin' %}class="active"{% endif %}>üè† Dashboard</a>
            <a href="/admin/assessments-overview">üìã M√•linger</a>
            <a href="/admin/analyser">üìä Analyser</a>
            <a href="/admin/tasks">üéØ Situationsm√•linger</a>
            <a href="/admin/profiler">üß† Friktionsprofil</a>
            <a href="/admin/units">üå≥ Organisationer</a>
            <a href="/admin/customers">üë• Kunder & Brugere</a>
        </div>

        <!-- Settings -->
        <div class="mobile-menu-section">
            <div class="mobile-menu-section-title">Indstillinger</div>
            <a href="/admin/my-branding">üé® Branding</a>
            <a href="/admin/email-stats">üìß Email Status</a>
            <a href="/admin/backup">üíæ Backup</a>
            <a href="/admin/dev-tools">üîß Dev Tools</a>
        </div>

        <!-- Account -->
        <div class="mobile-menu-section">
            <div class="mobile-menu-section-title">Konto</div>
            <a href="/set-language/{{ 'en' if get_user_language() == 'da' else 'da' }}">
                {% if get_user_language() == 'da' %}üá¨üáß English{% else %}üá©üá∞ Dansk{% endif %}
            </a>
            <a href="/admin/my-account">üë§ Min konto</a>
            <a href="/logout" style="color: #f87171;">üö™ Log ud</a>
        </div>
    </div>

    <!-- Submenu baseret p√• view mode -->
    <div class="submenu">
        <div class="submenu-container">
            {% set view_mode = session.get('view_mode', 'admin') %}

            {% if view_mode == 'user' %}
            <!-- Brugervisning submenu -->
            <ul class="submenu-links">
                <li><a href="/admin/user-view/survey" {% if 'user-view' in request.path %}class="active"{% endif %}>üìù Sp√∏rgeskema</a></li>
            </ul>

            {% elif view_mode == 'manager' or effective_role == 'manager' %}
            <!-- Ledervisning submenu -->
            <ul class="submenu-links">
                <li><a href="/admin/analyser" {% if 'analyser' in request.path %}class="active"{% endif %}>üìä Analyser</a></li>
                <li><a href="/admin" {% if request.path == '/admin' and 'assessment' not in request.path %}class="active"{% endif %}>üè¢ Organisationer</a></li>
            </ul>

            {% else %}
            <!-- Adminvisning submenu - reorganiseret med dropdowns -->
            <ul class="submenu-links">
                <!-- Dashboard - kombineret oversigt (KPIs + Trend + Analyser) -->
                <li><a href="/admin" {% if request.path == '/admin' %}class="active"{% endif %}>üè† {{ t('nav.dashboard') }}</a></li>

                <!-- M√•linger dropdown -->
                <li class="submenu-dropdown">
                    <a href="#" class="dropdown-toggle {% if 'assessments' in request.path or 'scheduled' in request.path or 'analyser' in request.path %}active{% endif %}">üìã {{ t('nav.maalinger', 'M√•linger') }} ‚ñæ</a>
                    <ul class="dropdown-menu">
                        <li><a href="/admin/assessments-overview" {% if 'assessments-overview' in request.path %}class="active"{% endif %}>üìã {{ t('nav.alle_maalinger') }}</a></li>
                        <li><a href="/admin/scheduled-assessments" {% if 'scheduled-assessments' in request.path %}class="active"{% endif %}>üìÖ {{ t('nav.planlagte', 'Planlagte') }}</a></li>
                        <li><a href="/admin/assessment/new" {% if 'assessment/new' in request.path %}class="active"{% endif %}>‚ûï {{ t('nav.ny_maaling', 'Ny m√•ling') }}</a></li>
                        <li style="border-top: 1px solid rgba(255,255,255,0.1); margin: 5px 0;"></li>
                        <li><a href="/admin/analyser" {% if 'analyser' in request.path %}class="active"{% endif %}>üìä {{ t('nav.analyser') }}</a></li>
                    </ul>
                </li>

                <!-- Situationsm√•linger dropdown -->
                <li class="submenu-dropdown">
                    <a href="#" class="dropdown-toggle {% if 'tasks' in request.path or active_page == 'tasks' %}active{% endif %}">üéØ Situationsm√•linger ‚ñæ</a>
                    <ul class="dropdown-menu">
                        <li><a href="/admin/tasks" {% if request.path == '/admin/tasks' %}class="active"{% endif %}>üìã Alle opgaver</a></li>
                        <li><a href="/admin/tasks/new" {% if 'tasks/new' in request.path %}class="active"{% endif %}>‚ûï Ny opgave</a></li>
                    </ul>
                </li>

                <!-- Friktionsprofil dropdown -->
                <li class="submenu-dropdown">
                    <a href="#" class="dropdown-toggle {% if 'profil' in request.path and 'profil-questions' not in request.path %}active{% endif %}">üß† {{ t('nav.friktionsprofil', 'Friktionsprofil') }} ‚ñæ</a>
                    <ul class="dropdown-menu">
                        <li><a href="/admin/profiler" {% if request.path == '/admin/profiler' %}class="active"{% endif %}>üìã {{ t('nav.alle_profiler', 'Alle profiler') }}</a></li>
                        <li><a href="/friktionsprofil/" target="_blank">üß™ {{ t('nav.tag_test', 'Tag profil-test') }} ‚Üó</a></li>
                        <li style="border-top: 1px solid rgba(255,255,255,0.1); margin: 5px 0;"></li>
                        <li><a href="/profil/local" target="_blank">üîí {{ t('nav.lokal_profil', 'Lokal profil (B2C)') }} ‚Üó</a></li>
                    </ul>
                </li>

                <!-- Organisation dropdown -->
                <li class="submenu-dropdown">
                    <a href="#" class="dropdown-toggle {% if 'units' in request.path or 'customers' in request.path or 'domains' in request.path %}active{% endif %}">üè¢ {{ t('nav.organisation', 'Organisation') }} ‚ñæ</a>
                    <ul class="dropdown-menu">
                        <li><a href="/admin/units" {% if 'units' in request.path %}class="active"{% endif %}>üå≥ {{ t('nav.organisationer') }}</a></li>
                        <li><a href="/admin/customers" {% if 'customers' in request.path %}class="active"{% endif %}>üë• {{ t('nav.kunder_brugere') }}</a></li>
                        {% if effective_role in ['admin', 'superadmin'] %}
                        <li><a href="/admin/domains" {% if 'domains' in request.path %}class="active"{% endif %}>üåê {{ t('nav.domaener', 'Dom√¶ner') }}</a></li>
                        {% endif %}
                    </ul>
                </li>

                <!-- Indstillinger dropdown -->
                <li class="submenu-dropdown">
                    <a href="#" class="dropdown-toggle {% if 'email' in request.path or 'profil-questions' in request.path or 'backup' in request.path or 'dev-tools' in request.path or 'my-branding' in request.path or 'auth-config' in request.path or 'assessment-types' in request.path or 'impersonate' in request.path or 'api-keys' in request.path %}active{% endif %}">‚öôÔ∏è {{ t('nav.indstillinger') }} ‚ñæ</a>
                    <ul class="dropdown-menu">
                        <li><a href="/admin/my-branding" {% if 'my-branding' in request.path %}class="active"{% endif %}>üé® {{ t('nav.branding', 'Min Branding') }}</a></li>
                        {% if effective_role == 'superadmin' or actual_role == 'superadmin' %}
                        <li><a href="/admin/auth-config" {% if 'auth-config' in request.path %}class="active"{% endif %}>üîê {{ t('nav.auth_config', 'Auth Konfiguration') }}</a></li>
                        <li><a href="/admin/assessment-types" {% if 'assessment-types' in request.path %}class="active"{% endif %}>üìã {{ t('nav.assessment_types', 'M√•lingstyper') }}</a></li>
                        <li><a href="/admin/impersonate" {% if 'impersonate' in request.path %}class="active"{% endif %}>üë§ {{ t('nav.impersonate', 'Impersoner bruger') }}</a></li>
                        {% endif %}
                        <li style="border-top: 1px solid rgba(255,255,255,0.1); margin: 5px 0;"></li>
                        <li><a href="/admin/profil-questions" {% if 'profil-questions' in request.path %}class="active"{% endif %}>üìù {{ t('nav.profil_spoergsmaal', 'Profil-sp√∏rgsm√•l') }}</a></li>
                        <li><a href="/admin/email-stats" {% if 'email-stats' in request.path %}class="active"{% endif %}>üìß {{ t('nav.email_status', 'Email Status') }}</a></li>
                        <li><a href="/admin/email-templates" {% if 'email-templates' in request.path %}class="active"{% endif %}>‚úâÔ∏è {{ t('nav.email_templates', 'Email Templates') }}</a></li>
                        {% if effective_role in ['admin', 'superadmin'] %}
                        <li><a href="/admin/api-keys" {% if 'api-keys' in request.path %}class="active"{% endif %}>üîë API Keys</a></li>
                        {% endif %}
                        <li style="border-top: 1px solid rgba(255,255,255,0.1); margin: 5px 0;"></li>
                        <li><a href="/admin/backup" {% if 'backup' in request.path %}class="active"{% endif %}>üíæ {{ t('nav.backup', 'Backup & Restore') }}</a></li>
                        <li><a href="/admin/audit-log" {% if 'audit-log' in request.path %}class="active"{% endif %}>üìã {{ t('nav.audit_log', 'Audit Log') }}</a></li>
                        <li><a href="/admin/gdpr" {% if 'gdpr' in request.path %}class="active"{% endif %}>üîí GDPR & Data</a></li>
                        <li><a href="/admin/dev-tools" {% if 'dev-tools' in request.path %}class="active"{% endif %}>üîß {{ t('nav.dev_tools', 'Dev Tools') }}</a></li>
                    </ul>
                </li>
            </ul>
            {% endif %}
        </div>
    </div>

    <!-- Toast container for notifications -->
    <div id="toastContainer" class="toast-container" role="alert" aria-live="polite"></div>

    <main id="main-content" class="container" role="main">
        {% block content %}{% endblock %}
    </main>

    <!-- Flash messages as toasts (from server) -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                {% for category, message in messages %}
                showToast('{{ message|e }}', '{{ category }}');
                {% endfor %}
            });
        </script>
        {% endif %}
    {% endwith %}

    <!-- Loading overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">{{ t('loading') if t else 'Arbejder...' }}</div>
    </div>

    <style>
    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 9999;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }
    .loading-overlay.active {
        display: flex;
    }
    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top-color: #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    .loading-text {
        color: white;
        margin-top: 15px;
        font-size: 1rem;
        font-weight: 500;
    }
    </style>

    <script>
    // Mobile menu toggle
    function toggleMobileMenu() {
        var menu = document.getElementById('mobileMenu');
        var btn = document.querySelector('.hamburger-btn');
        menu.classList.toggle('active');
        btn.classList.toggle('active');
        // Prevent body scroll when menu is open
        document.body.style.overflow = menu.classList.contains('active') ? 'hidden' : '';
    }

    // Close mobile menu
    function closeMobileMenu() {
        var menu = document.getElementById('mobileMenu');
        var btn = document.querySelector('.hamburger-btn');
        if (menu && menu.classList.contains('active')) {
            menu.classList.remove('active');
            btn.classList.remove('active');
            document.body.style.overflow = '';
        }
    }

    // Close menu when clicking a link (before navigation)
    document.addEventListener('DOMContentLoaded', function() {
        var mobileMenu = document.getElementById('mobileMenu');
        if (mobileMenu) {
            mobileMenu.querySelectorAll('a').forEach(function(link) {
                link.addEventListener('click', function() {
                    closeMobileMenu();
                });
            });
        }
    });

    // Close menu when page is shown (handles back button)
    window.addEventListener('pageshow', function(event) {
        // Always close menu when page is shown (including from bfcache)
        closeMobileMenu();
    });

    // Handle resize - close mobile menu and force layout update
    var resizeTimeout;
    window.addEventListener('resize', function() {
        // Close mobile menu if resizing to desktop
        if (window.innerWidth > 767) {
            closeMobileMenu();
        }

        // Debounced layout force (for orientation changes)
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(function() {
            document.documentElement.style.overflow = 'hidden';
            document.documentElement.offsetHeight; // Force reflow
            document.documentElement.style.overflow = '';
        }, 150);
    });

    // Handle orientation change - force immediate layout recalculation
    window.addEventListener('orientationchange', function() {
        // Hide and show to force complete relayout
        document.body.style.display = 'none';
        document.body.offsetHeight; // Trigger reflow
        document.body.style.display = '';

        // Trigger resize after browser viewport adjusts
        setTimeout(function() {
            window.dispatchEvent(new Event('resize'));
        }, 100);

        // Second pass for stubborn browsers
        setTimeout(function() {
            document.body.style.opacity = '0.999';
            requestAnimationFrame(function() {
                document.body.style.opacity = '';
            });
        }, 300);
    });

    function switchCustomer(customerId) {
        // Get current path to return to after switching
        var currentPath = window.location.pathname;
        var returnUrl = encodeURIComponent(currentPath);

        if (customerId === "") {
            // Stop impersonating - stay on current page type
            window.location.href = "/admin/stop-impersonate?next=" + returnUrl;
        } else {
            // Switch to this customer - stay on current page type
            window.location.href = "/admin/impersonate/" + customerId + "?next=" + returnUrl;
        }
    }

    function switchRole(role) {
        // Switch simulated role for superadmin
        var currentPath = window.location.pathname;
        var returnUrl = encodeURIComponent(currentPath);
        window.location.href = "/admin/simulate-role/" + (role || "clear") + "?next=" + returnUrl;
    }

    // Loading spinner functions
    function showLoading(text) {
        var overlay = document.getElementById('loadingOverlay');
        if (text) {
            overlay.querySelector('.loading-text').textContent = text;
        }
        overlay.classList.add('active');
    }

    function hideLoading() {
        document.getElementById('loadingOverlay').classList.remove('active');
    }

    // Auto-attach to forms with data-loading attribute
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('form[data-loading]').forEach(function(form) {
            form.addEventListener('submit', function() {
                var loadingText = this.getAttribute('data-loading');
                showLoading(loadingText || null);
            });
        });
    });

    // Toast notification system
    function showToast(message, type, duration) {
        type = type || 'info';
        duration = duration || (type === 'error' ? 8000 : 5000);

        var container = document.getElementById('toastContainer');
        var toast = document.createElement('div');
        toast.className = 'toast ' + type;

        var icons = {
            'success': '‚úì',
            'error': '‚úï',
            'warning': '‚ö†',
            'info': '‚Ñπ'
        };

        toast.innerHTML =
            '<span class="toast-icon">' + (icons[type] || icons.info) + '</span>' +
            '<span class="toast-message">' + message + '</span>' +
            '<button class="toast-close" onclick="closeToast(this.parentElement)">√ó</button>';

        container.appendChild(toast);

        // Auto-dismiss
        setTimeout(function() {
            closeToast(toast);
        }, duration);
    }

    function closeToast(toast) {
        if (!toast || toast.classList.contains('hiding')) return;
        toast.classList.add('hiding');
        setTimeout(function() {
            if (toast.parentElement) {
                toast.parentElement.removeChild(toast);
            }
        }, 300);
    }

    // Form validation helper functions
    var FormValidation = {
        // Show error on a form field
        showError: function(input, message) {
            var group = input.closest('.form-group');
            if (!group) return;

            // Remove any existing error
            this.clearError(input);

            group.classList.add('has-error');
            group.classList.remove('has-success');

            var errorEl = document.createElement('div');
            errorEl.className = 'form-error';
            errorEl.textContent = message;
            group.appendChild(errorEl);
        },

        // Clear error from a form field
        clearError: function(input) {
            var group = input.closest('.form-group');
            if (!group) return;

            group.classList.remove('has-error');
            var errorEl = group.querySelector('.form-error');
            if (errorEl) errorEl.remove();
        },

        // Show success state
        showSuccess: function(input) {
            var group = input.closest('.form-group');
            if (!group) return;

            this.clearError(input);
            group.classList.add('has-success');
        },

        // Validate email format
        isValidEmail: function(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        },

        // Common validation messages (Danish)
        messages: {
            required: 'Dette felt er p√•kr√¶vet',
            email: 'Indtast en gyldig email-adresse',
            minLength: function(n) { return 'Minimum ' + n + ' tegn p√•kr√¶vet'; },
            maxLength: function(n) { return 'Maksimum ' + n + ' tegn tilladt'; },
            passwordMatch: 'Passwords matcher ikke',
            invalidFormat: 'Ugyldigt format'
        },

        // Validate a single input
        validateInput: function(input) {
            var value = input.value.trim();
            var type = input.type;
            var required = input.hasAttribute('required');
            var minLength = input.getAttribute('minlength');
            var maxLength = input.getAttribute('maxlength');

            // Required check
            if (required && !value) {
                this.showError(input, this.messages.required);
                return false;
            }

            // Skip further validation if empty and not required
            if (!value) {
                this.clearError(input);
                return true;
            }

            // Email validation
            if (type === 'email' && !this.isValidEmail(value)) {
                this.showError(input, this.messages.email);
                return false;
            }

            // Min length
            if (minLength && value.length < parseInt(minLength)) {
                this.showError(input, this.messages.minLength(minLength));
                return false;
            }

            // Max length
            if (maxLength && value.length > parseInt(maxLength)) {
                this.showError(input, this.messages.maxLength(maxLength));
                return false;
            }

            this.showSuccess(input);
            return true;
        },

        // Validate entire form
        validateForm: function(form) {
            var inputs = form.querySelectorAll('input, select, textarea');
            var isValid = true;
            var firstError = null;

            inputs.forEach(function(input) {
                if (!this.validateInput(input)) {
                    isValid = false;
                    if (!firstError) firstError = input;
                }
            }.bind(this));

            // Focus first error field
            if (firstError) {
                firstError.focus();
            }

            return isValid;
        },

        // Initialize validation on a form
        init: function(form) {
            var self = this;

            // Validate on blur (when user leaves field)
            form.querySelectorAll('input, select, textarea').forEach(function(input) {
                input.addEventListener('blur', function() {
                    self.validateInput(this);
                });

                // Clear error when user starts typing
                input.addEventListener('input', function() {
                    var group = this.closest('.form-group');
                    if (group && group.classList.contains('has-error')) {
                        self.clearError(this);
                    }
                });
            });

            // Validate on submit
            form.addEventListener('submit', function(e) {
                if (!self.validateForm(form)) {
                    e.preventDefault();
                    showToast('Ret venligst fejlene i formularen', 'error');
                }
            });
        }
    };

    // Auto-initialize validation on forms with data-validate attribute
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('form[data-validate]').forEach(function(form) {
            FormValidation.init(form);
        });
    });

    // Password visibility toggle utility
    function initPasswordToggles() {
        document.querySelectorAll('input[type="password"]').forEach(function(passwordInput) {
            // Skip if already has a toggle
            if (passwordInput.nextElementSibling && passwordInput.nextElementSibling.classList.contains('password-toggle')) {
                return;
            }

            // Create wrapper if not exists
            var wrapper = passwordInput.parentElement;
            if (!wrapper.classList.contains('password-wrapper')) {
                wrapper = document.createElement('div');
                wrapper.className = 'password-wrapper';
                wrapper.style.position = 'relative';
                passwordInput.parentNode.insertBefore(wrapper, passwordInput);
                wrapper.appendChild(passwordInput);
            }

            // Create toggle button
            var toggleBtn = document.createElement('button');
            toggleBtn.type = 'button';
            toggleBtn.className = 'password-toggle';
            toggleBtn.setAttribute('aria-label', 'Vis password');
            toggleBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>';

            toggleBtn.style.position = 'absolute';
            toggleBtn.style.right = '10px';
            toggleBtn.style.top = '50%';
            toggleBtn.style.transform = 'translateY(-50%)';
            toggleBtn.style.background = 'none';
            toggleBtn.style.border = 'none';
            toggleBtn.style.cursor = 'pointer';
            toggleBtn.style.padding = '5px';
            toggleBtn.style.display = 'flex';
            toggleBtn.style.alignItems = 'center';
            toggleBtn.style.justifyContent = 'center';
            toggleBtn.style.color = '#6b7280';
            toggleBtn.style.transition = 'color 0.2s';

            toggleBtn.addEventListener('mouseenter', function() {
                this.style.color = '#1f2937';
            });
            toggleBtn.addEventListener('mouseleave', function() {
                this.style.color = '#6b7280';
            });

            // Toggle functionality
            toggleBtn.addEventListener('click', function() {
                var isPassword = passwordInput.type === 'password';
                passwordInput.type = isPassword ? 'text' : 'password';

                // Update icon - eye with slash when visible
                if (isPassword) {
                    toggleBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>';
                    toggleBtn.setAttribute('aria-label', 'Skjul password');
                } else {
                    toggleBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>';
                    toggleBtn.setAttribute('aria-label', 'Vis password');
                }
            });

            // Add padding to input to make room for button
            passwordInput.style.paddingRight = '40px';

            wrapper.appendChild(toggleBtn);
        });
    }

    // Keyboard navigation - Enter to submit forms
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize password toggles
        initPasswordToggles();

        // Allow Enter key to submit forms from input fields
        document.querySelectorAll('form input:not([type="submit"]):not([type="button"])').forEach(function(input) {
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    // Don't submit if it's a search input or has specific handling
                    if (input.classList.contains('no-enter-submit')) return;

                    var form = input.closest('form');
                    if (form) {
                        // If there's a next input, move to it instead of submitting
                        var inputs = Array.from(form.querySelectorAll('input:not([type="submit"]):not([type="button"]):not([type="hidden"]), select, textarea'));
                        var currentIndex = inputs.indexOf(input);

                        // If this is the last input (or a password field), submit
                        if (currentIndex === inputs.length - 1 || input.type === 'password') {
                            e.preventDefault();
                            // Find and click submit button, or submit form directly
                            var submitBtn = form.querySelector('button[type="submit"], input[type="submit"]');
                            if (submitBtn) {
                                submitBtn.click();
                            } else {
                                form.submit();
                            }
                        }
                        // Otherwise, let default behavior move to next field
                    }
                }
            });
        });

        // Escape key to close modals/dropdowns
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                // Close any open dropdowns
                document.querySelectorAll('.dropdown-menu').forEach(function(menu) {
                    menu.style.display = 'none';
                });

                // Close loading overlay if somehow stuck
                var overlay = document.getElementById('loadingOverlay');
                if (overlay && overlay.classList.contains('active')) {
                    // Only close if it's been showing for more than 30 seconds (stuck)
                    // This prevents accidentally closing during actual loading
                }
            }
        });

        // Tab key navigation improvements for dropdowns
        document.querySelectorAll('.submenu-dropdown').forEach(function(dropdown) {
            var toggle = dropdown.querySelector('.dropdown-toggle');
            var menu = dropdown.querySelector('.dropdown-menu');

            if (toggle && menu) {
                // Open dropdown with Enter/Space when focused
                toggle.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        var isVisible = menu.style.opacity === '1' || window.getComputedStyle(menu).opacity === '1';
                        if (!isVisible) {
                            // Trigger hover state
                            dropdown.dispatchEvent(new MouseEvent('mouseenter'));
                        }
                    }
                });
            }
        });
    });
    </script>
    <script src="{{ url_for('static', filename='js/modal-utils.js') }}"></script>
    <script>
    // Auto-inject CSRF tokens into all POST forms
    (function() {
        var csrfToken = document.querySelector('meta[name="csrf-token"]');
        if (!csrfToken) return;

        var token = csrfToken.getAttribute('content');
        document.querySelectorAll('form[method="POST"], form[method="post"]').forEach(function(form) {
            // Skip if already has CSRF token
            if (form.querySelector('input[name="csrf_token"]')) return;

            var input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'csrf_token';
            input.value = token;
            form.insertBefore(input, form.firstChild);
        });
    })();
    </script>
    {% block extra_js %}{% endblock %}
</body>
</html>
