<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <title>{% block title %}Admin{% endblock %} - Friktionskompasset</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #f9fafb;
        }

        /* Navigation */
        .nav {
            background: #1f2937;
            color: white;
            padding: 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
        }
        .nav-brand {
            font-size: 1.25rem;
            font-weight: 600;
            padding: 20px 0;
        }

        /* Top menu - View switcher */
        .view-switcher {
            display: flex;
            gap: 5px;
            list-style: none;
            background: rgba(0,0,0,0.2);
            padding: 5px;
            border-radius: 8px;
        }
        .view-switcher a {
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            padding: 10px 20px;
            display: block;
            transition: all 0.2s;
            border-radius: 6px;
            font-weight: 500;
        }
        .view-switcher a:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        .view-switcher a.active {
            background: #3b82f6;
            color: white;
        }

        /* Submenu */
        .submenu {
            background: #374151;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .submenu-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }
        .submenu-links {
            display: flex;
            gap: 5px;
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .submenu-links a {
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            padding: 12px 15px;
            display: block;
            transition: all 0.2s;
            font-size: 0.875rem;
        }
        .submenu-links a:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        .submenu-links a.active {
            background: rgba(59, 130, 246, 0.3);
            color: white;
            border-bottom: 2px solid #3b82f6;
        }

        /* Dropdown menu i submenu */
        .submenu-dropdown {
            position: relative;
        }
        .submenu-dropdown .dropdown-toggle {
            cursor: pointer;
        }
        .submenu-dropdown .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: #1f2937;
            border-radius: 0 0 6px 6px;
            min-width: 180px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 100;
            list-style: none;
            padding: 5px 0;
        }
        .submenu-dropdown:hover .dropdown-menu {
            display: block;
        }
        .submenu-dropdown .dropdown-menu a {
            padding: 10px 15px;
            display: block;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            font-size: 0.85rem;
        }
        .submenu-dropdown .dropdown-menu a:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        .submenu-dropdown .dropdown-menu a.active {
            background: rgba(59, 130, 246, 0.3);
            border-bottom: none;
        }

        .nav-user {
            color: rgba(255,255,255,0.6);
            font-size: 0.875rem;
        }
        .user-badge {
            display: inline-block;
            background: #3b82f6;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
        }

        /* Customer switcher */
        .customer-switcher {
            margin-left: 20px;
        }
        .customer-switcher select {
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .customer-switcher select:hover {
            background: rgba(255,255,255,0.15);
            border-color: rgba(255,255,255,0.5);
        }
        .customer-switcher select option {
            background: #1f2937;
            color: white;
        }

        /* Main content */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Toast notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 400px;
        }
        .toast {
            padding: 16px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease-out;
            cursor: pointer;
            transition: opacity 0.3s, transform 0.3s;
        }
        .toast:hover {
            transform: translateX(-5px);
        }
        .toast.hiding {
            opacity: 0;
            transform: translateX(100%);
        }
        .toast-icon {
            font-size: 1.2rem;
            flex-shrink: 0;
        }
        .toast-message {
            flex: 1;
            font-size: 0.95rem;
            line-height: 1.4;
        }
        .toast-close {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            opacity: 0.6;
            padding: 0;
            line-height: 1;
        }
        .toast-close:hover { opacity: 1; }
        .toast.success { background: #d1fae5; color: #065f46; border-left: 4px solid #10b981; }
        .toast.error { background: #fee2e2; color: #991b1b; border-left: 4px solid #ef4444; }
        .toast.warning { background: #fef3c7; color: #92400e; border-left: 4px solid #f59e0b; }
        .toast.info { background: #dbeafe; color: #1e40af; border-left: 4px solid #3b82f6; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }
    </style>
    {% block extra_css %}{% endblock %}
</head>
<body>
    <nav class="nav">
        <div class="nav-container">
            <div class="nav-brand">üè¢ Friktionskompasset</div>

            {% if session.user.role == 'admin' and not session.impersonating %}
            <!-- View switcher - kun for admin -->
            <ul class="view-switcher">
                <li><a href="/admin/view/user" {% if session.get('view_mode') == 'user' %}class="active"{% endif %}>üë§ Brugervisning</a></li>
                <li><a href="/admin/view/manager" {% if session.get('view_mode') == 'manager' %}class="active"{% endif %}>üëî Ledervisning</a></li>
                <li><a href="/admin/view/admin" {% if session.get('view_mode', 'admin') == 'admin' %}class="active"{% endif %}>üîß Adminvisning</a></li>
            </ul>
            {% endif %}

            {% if session.user.role == 'admin' %}
            <!-- Customer switcher dropdown -->
            <div class="customer-switcher">
                <select id="customerSelect" onchange="switchCustomer(this.value)">
                    <option value="">üåç Alle kunder</option>
                    {% for customer in customers %}
                    <option value="{{ customer.id }}"
                        {% if session.customer_filter == customer.id %}selected
                        {% elif current_filter == customer.id %}selected
                        {% endif %}>
                        {{ customer.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}

            <div class="nav-user">
                {{ session.user.name }}
                <span class="user-badge">{{ session.user.role|upper }}</span>
                {% if session.user.customer_name %}
                <span style="opacity: 0.6; margin-left: 10px;">{{ session.user.customer_name }}</span>
                {% endif %}
                {% if session.impersonating %}
                <a href="/admin/stop-impersonate" style="background: #ef4444; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; margin-left: 8px; text-decoration: none;">‚Üê Tilbage til Admin</a>
                {% endif %}
                <!-- Sprogv√¶lger -->
                <span class="lang-switcher" style="margin-left: 15px;">
                    {% set current_lang = get_user_language() %}
                    <a href="/set-language/da" style="color: {% if current_lang == 'da' %}white{% else %}rgba(255,255,255,0.5){% endif %}; text-decoration: none; font-size: 0.85rem;">DA</a>
                    <span style="color: rgba(255,255,255,0.3);">|</span>
                    <a href="/set-language/en" style="color: {% if current_lang == 'en' %}white{% else %}rgba(255,255,255,0.5){% endif %}; text-decoration: none; font-size: 0.85rem;">EN</a>
                </span>
                <a href="/logout" style="color: rgba(255,255,255,0.8); margin-left: 15px; text-decoration: none;">{{ t('nav.logout') }}</a>
            </div>
        </div>
    </nav>

    <!-- Submenu baseret p√• view mode -->
    <div class="submenu">
        <div class="submenu-container">
            {% set view_mode = session.get('view_mode', 'admin') %}

            {% if view_mode == 'user' %}
            <!-- Brugervisning submenu -->
            <ul class="submenu-links">
                <li><a href="/admin/user-view/survey" {% if 'user-view' in request.path %}class="active"{% endif %}>üìù Sp√∏rgeskema</a></li>
            </ul>

            {% elif view_mode == 'manager' or session.user.role == 'manager' %}
            <!-- Ledervisning submenu -->
            <ul class="submenu-links">
                <li><a href="/admin/analyser" {% if 'analyser' in request.path %}class="active"{% endif %}>üìä Analyser</a></li>
                <li><a href="/admin" {% if request.path == '/admin' and 'campaign' not in request.path %}class="active"{% endif %}>üè¢ Organisationer</a></li>
            </ul>

            {% else %}
            <!-- Adminvisning submenu -->
            <ul class="submenu-links">
                <li><a href="/admin/dashboard" {% if 'dashboard' in request.path %}class="active"{% endif %}>üìà {{ t('nav.dashboard') }}</a></li>
                <li><a href="/admin/analyser" {% if 'analyser' in request.path and 'dashboard' not in request.path %}class="active"{% endif %}>üìä {{ t('nav.analyser') }}</a></li>
                <li><a href="/admin" {% if request.path == '/admin' and 'campaign' not in request.path and 'dashboard' not in request.path and 'analyser' not in request.path %}class="active"{% endif %}>üè¢ {{ t('nav.organisationer') }}</a></li>
                <li><a href="/admin/profiler" {% if 'profiler' in request.path %}class="active"{% endif %}>üî¨ {{ t('nav.friktionsprofiler') }}</a></li>
                <li><a href="/admin/customers" {% if 'customers' in request.path %}class="active"{% endif %}>üë• {{ t('nav.kunder_brugere') }}</a></li>
                <li class="submenu-dropdown">
                    <a href="#" class="dropdown-toggle {% if 'email' in request.path or 'settings' in request.path or 'profil-questions' in request.path or 'seed' in request.path %}active{% endif %}">‚öôÔ∏è {{ t('nav.indstillinger') }} ‚ñæ</a>
                    <ul class="dropdown-menu">
                        <li><a href="/admin/profil-questions" {% if 'profil-questions' in request.path %}class="active"{% endif %}>üìù Profil-sp√∏rgsm√•l</a></li>
                        <li><a href="/admin/email-stats" {% if 'email-stats' in request.path %}class="active"{% endif %}>üìß Email Status</a></li>
                        <li><a href="/admin/email-templates" {% if 'email-templates' in request.path %}class="active"{% endif %}>‚úâÔ∏è Email Templates</a></li>
                        <li><a href="/admin/seed-testdata" {% if 'seed' in request.path %}class="active"{% endif %}>üå± Seed Testdata</a></li>
                    </ul>
                </li>
            </ul>
            {% endif %}
        </div>
    </div>

    <!-- Toast container for notifications -->
    <div id="toastContainer" class="toast-container"></div>

    <div class="container">
        {% block content %}{% endblock %}
    </div>

    <!-- Flash messages as toasts (from server) -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                {% for category, message in messages %}
                showToast('{{ message|e }}', '{{ category }}');
                {% endfor %}
            });
        </script>
        {% endif %}
    {% endwith %}

    <!-- Loading overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">{{ t('loading') if t else 'Arbejder...' }}</div>
    </div>

    <style>
    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 9999;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }
    .loading-overlay.active {
        display: flex;
    }
    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top-color: #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    .loading-text {
        color: white;
        margin-top: 15px;
        font-size: 1rem;
        font-weight: 500;
    }
    </style>

    <script>
    function switchCustomer(customerId) {
        // Get current path to return to after switching
        var currentPath = window.location.pathname;
        var returnUrl = encodeURIComponent(currentPath);

        if (customerId === "") {
            // Stop impersonating - stay on current page type
            window.location.href = "/admin/stop-impersonate?next=" + returnUrl;
        } else {
            // Switch to this customer - stay on current page type
            window.location.href = "/admin/impersonate/" + customerId + "?next=" + returnUrl;
        }
    }

    // Loading spinner functions
    function showLoading(text) {
        var overlay = document.getElementById('loadingOverlay');
        if (text) {
            overlay.querySelector('.loading-text').textContent = text;
        }
        overlay.classList.add('active');
    }

    function hideLoading() {
        document.getElementById('loadingOverlay').classList.remove('active');
    }

    // Auto-attach to forms with data-loading attribute
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('form[data-loading]').forEach(function(form) {
            form.addEventListener('submit', function() {
                var loadingText = this.getAttribute('data-loading');
                showLoading(loadingText || null);
            });
        });
    });

    // Toast notification system
    function showToast(message, type, duration) {
        type = type || 'info';
        duration = duration || (type === 'error' ? 8000 : 5000);

        var container = document.getElementById('toastContainer');
        var toast = document.createElement('div');
        toast.className = 'toast ' + type;

        var icons = {
            'success': '‚úì',
            'error': '‚úï',
            'warning': '‚ö†',
            'info': '‚Ñπ'
        };

        toast.innerHTML =
            '<span class="toast-icon">' + (icons[type] || icons.info) + '</span>' +
            '<span class="toast-message">' + message + '</span>' +
            '<button class="toast-close" onclick="closeToast(this.parentElement)">√ó</button>';

        container.appendChild(toast);

        // Auto-dismiss
        setTimeout(function() {
            closeToast(toast);
        }, duration);
    }

    function closeToast(toast) {
        if (!toast || toast.classList.contains('hiding')) return;
        toast.classList.add('hiding');
        setTimeout(function() {
            if (toast.parentElement) {
                toast.parentElement.removeChild(toast);
            }
        }, 300);
    }
    </script>
</body>
</html>
