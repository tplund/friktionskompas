{% extends "admin/layout.html" %}

{% block title %}Dashboard{% endblock %}

{% block extra_css %}
<style>
    /* KPI Cards */
    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 15px;
        margin-bottom: 25px;
    }
    .kpi-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        border: 1px solid #e5e7eb;
    }
    .kpi-card .label {
        color: #6b7280;
        font-size: 0.85rem;
        margin-bottom: 8px;
    }
    .kpi-card .value {
        color: #374151;
        font-size: 2rem;
        font-weight: 600;
    }
    .kpi-card .subtitle {
        color: #9ca3af;
        font-size: 0.75rem;
        margin-top: 4px;
    }
    .kpi-card.highlight {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    }
    .kpi-card.highlight .label,
    .kpi-card.highlight .value,
    .kpi-card.highlight .subtitle {
        color: white;
    }
    .kpi-card.alert {
        background: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
    }
    .kpi-card.alert .label,
    .kpi-card.alert .value,
    .kpi-card.alert .subtitle {
        color: white;
    }

    /* Friktion cards */
    .friction-cards {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;
        margin-bottom: 25px;
    }
    @media (max-width: 900px) {
        .friction-cards {
            grid-template-columns: repeat(2, 1fr);
        }
    }
    .friction-card {
        background: white;
        border-radius: 8px;
        padding: 18px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        border: 1px solid #e5e7eb;
        cursor: pointer;
        transition: all 0.15s;
    }
    .friction-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .friction-card .field-name {
        font-size: 0.85rem;
        font-weight: 600;
        color: #374151;
        margin-bottom: 8px;
    }
    .friction-card .field-score {
        font-size: 1.75rem;
        font-weight: 700;
        margin-bottom: 8px;
    }
    .friction-card .field-bar {
        height: 6px;
        background: #e5e7eb;
        border-radius: 3px;
        overflow: hidden;
    }
    .friction-card .field-bar-fill {
        height: 100%;
        border-radius: 3px;
        transition: width 0.3s ease;
    }
    .friction-card.low .field-score { color: #dc2626; }
    .friction-card.low .field-bar-fill { background: #dc2626; }
    .friction-card.medium .field-score { color: #f59e0b; }
    .friction-card.medium .field-bar-fill { background: #f59e0b; }
    .friction-card.high .field-score { color: #10b981; }
    .friction-card.high .field-bar-fill { background: #10b981; }

    /* Main content area */
    .main-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
        margin-bottom: 25px;
    }
    @media (max-width: 1100px) {
        .main-grid {
            grid-template-columns: 1fr;
        }
    }

    .card {
        background: white;
        border-radius: 8px;
        padding: 25px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        border: 1px solid #e5e7eb;
    }
    .card h2 {
        margin-bottom: 20px;
        color: #374151;
        font-weight: 600;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .card h2 a {
        font-size: 0.8rem;
        font-weight: 500;
        color: #6366f1;
        text-decoration: none;
    }
    .card h2 a:hover {
        text-decoration: underline;
    }

    /* Trend chart */
    .chart-container {
        position: relative;
        height: 280px;
    }
    .filter-bar {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
    }
    .filter-bar select {
        padding: 6px 10px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        background: white;
        font-size: 0.85rem;
        min-width: 180px;
    }
    .filter-bar label {
        color: #6b7280;
        font-size: 0.85rem;
    }

    /* Recent assessments */
    .recent-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    .recent-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 15px;
        background: #f9fafb;
        border-radius: 6px;
        border: 1px solid #e5e7eb;
        transition: all 0.15s;
        text-decoration: none;
        color: inherit;
    }
    .recent-item:hover {
        background: #eef2ff;
        border-color: #c7d2fe;
    }
    .recent-item .name {
        font-weight: 500;
        color: #374151;
        font-size: 0.9rem;
    }
    .recent-item .meta {
        font-size: 0.75rem;
        color: #9ca3af;
        margin-top: 2px;
    }
    .recent-item .responses {
        text-align: right;
    }
    .recent-item .responses .count {
        font-weight: 600;
        color: #4f46e5;
        font-size: 1rem;
    }
    .recent-item .responses .label {
        font-size: 0.7rem;
        color: #9ca3af;
    }

    /* Alerts section */
    .alerts-section {
        margin-bottom: 25px;
    }
    .alert-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 15px;
        background: #fef2f2;
        border: 1px solid #fecaca;
        border-radius: 6px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.15s;
    }
    .alert-item:hover {
        background: #fee2e2;
    }
    .alert-item .icon {
        font-size: 1.25rem;
    }
    .alert-item .text {
        flex: 1;
        font-size: 0.9rem;
        color: #991b1b;
    }
    .alert-item .action {
        color: #dc2626;
        font-size: 0.8rem;
        font-weight: 500;
    }

    /* Unit drill-down table */
    .unit-table {
        width: 100%;
        border-collapse: collapse;
    }
    .unit-table th {
        text-align: left;
        padding: 10px 12px;
        border-bottom: 2px solid #e5e7eb;
        color: #6b7280;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    .unit-table th.sortable {
        cursor: pointer;
    }
    .unit-table th.sortable:hover {
        color: #374151;
    }
    .unit-table td {
        padding: 12px;
        border-bottom: 1px solid #f3f4f6;
        font-size: 0.9rem;
        color: #374151;
    }
    .unit-table tr {
        cursor: pointer;
        transition: background 0.15s;
    }
    .unit-table tr:hover {
        background: #f9fafb;
    }
    .unit-table .unit-name {
        font-weight: 500;
    }
    .unit-table .assessment-name {
        font-size: 0.75rem;
        color: #9ca3af;
        margin-top: 2px;
    }
    .score-cell {
        text-align: center;
    }
    .score-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    .score-badge.high { background: #dcfce7; color: #166534; }
    .score-badge.medium { background: #fef3c7; color: #92400e; }
    .score-badge.low { background: #fee2e2; color: #991b1b; }

    .empty-state {
        text-align: center;
        color: #9ca3af;
        padding: 40px 20px;
        font-style: italic;
    }

    /* Indicators */
    .indicator {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 0.7rem;
        font-weight: 500;
        margin-left: 8px;
    }
    .indicator.gap {
        background: #fef3c7;
        color: #92400e;
    }
    .indicator.substitution {
        background: #dbeafe;
        color: #1e40af;
    }
</style>
{% endblock %}

{% block content %}
<!-- KPI Cards -->
<div class="kpi-grid">
    {% if show_customer_stats %}
    <div class="kpi-card">
        <div class="label">{{ t('noegletal.kunder') }}</div>
        <div class="value">{{ total_customers }}</div>
    </div>
    {% endif %}
    <div class="kpi-card">
        <div class="label">{{ t('nav.organisationer') }}</div>
        <div class="value">{{ total_units }}</div>
    </div>
    <div class="kpi-card">
        <div class="label">{{ t('nav.analyser') }}</div>
        <div class="value">{{ total_assessments }}</div>
    </div>
    <div class="kpi-card highlight">
        <div class="label">{{ t('noegletal.besvarelser') }}</div>
        <div class="value">{{ total_responses }}</div>
    </div>
    {% if alerts|length > 0 %}
    <div class="kpi-card alert">
        <div class="label">Advarsler</div>
        <div class="value">{{ alerts|length }}</div>
        <div class="subtitle">Klik for at se</div>
    </div>
    {% endif %}
</div>

<!-- Friction overview cards -->
<div class="friction-cards">
    {% for field in field_scores %}
    {% set score_class = 'low' if field.avg_score < 2.5 else ('medium' if field.avg_score < 3.5 else 'high') %}
    <div class="friction-card {{ score_class }}" onclick="location.href='/admin/analyser?sort={{ field.field|lower }}&order=asc'">
        <div class="field-name">{{ field.field }}</div>
        <div class="field-score">{{ "%.1f"|format(field.avg_score) }}</div>
        <div class="field-bar">
            <div class="field-bar-fill" style="width: {{ (field.avg_score / 5 * 100)|int }}%"></div>
        </div>
    </div>
    {% else %}
    <div class="friction-card" style="grid-column: span 4; text-align: center; color: #9ca3af;">
        Ingen data endnu
    </div>
    {% endfor %}
</div>

<!-- Alerts section (if any) -->
{% if alerts %}
<div class="alerts-section">
    {% for alert in alerts[:5] %}
    <div class="alert-item" onclick="location.href='/admin/assessment/{{ alert.assessment_id }}/detailed'">
        <span class="icon">{{ alert.icon }}</span>
        <span class="text">{{ alert.text }}</span>
        <span class="action">Se analyse &rarr;</span>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Main content grid: Trend + Recent -->
<div class="main-grid">
    <!-- Trend chart -->
    <div class="card">
        <h2>
            Trend over tid
            <a href="/admin/trend">Se alle &rarr;</a>
        </h2>
        <div class="filter-bar">
            <label>Enhed:</label>
            <select id="unitFilter" onchange="filterByUnit(this.value)">
                <option value="">Alle enheder</option>
                {% for unit in units %}
                <option value="{{ unit.id }}" {% if selected_unit == unit.id %}selected{% endif %}>
                    {{ '—' * unit.level }} {{ unit.name }}
                </option>
                {% endfor %}
            </select>
        </div>
        {% if trend_data.assessments %}
        <div class="chart-container">
            <canvas id="trendChart"></canvas>
        </div>
        {% else %}
        <div class="empty-state">Ingen trenddata endnu</div>
        {% endif %}
    </div>

    <!-- Recent assessments -->
    <div class="card">
        <h2>
            Seneste målinger
            <a href="/admin/assessments-overview">Se alle &rarr;</a>
        </h2>
        {% if recent_assessments %}
        <div class="recent-list">
            {% for c in recent_assessments %}
            <a href="/admin/assessment/{{ c.id }}/detailed" class="recent-item">
                <div>
                    <div class="name">{{ c.name }}</div>
                    <div class="meta">{{ c.unit_name }}{% if c.period %} &middot; {{ c.period }}{% endif %}</div>
                </div>
                <div class="responses">
                    <div class="count">{{ c.response_count }}</div>
                    <div class="label">svar</div>
                </div>
            </a>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">Ingen målinger endnu</div>
        {% endif %}
    </div>
</div>

<!-- Unit drill-down table -->
<div class="card">
    <h2>
        Analyse per enhed
        <a href="/admin/analyser">Se detaljeret &rarr;</a>
    </h2>
    {% if unit_scores %}
    <div style="overflow-x: auto;">
        <table class="unit-table">
            <thead>
                <tr>
                    <th>Enhed / Måling</th>
                    <th>Svar</th>
                    <th class="score-cell">MENING</th>
                    <th class="score-cell">TRYGHED</th>
                    <th class="score-cell">KAN</th>
                    <th class="score-cell">BESVÆR</th>
                </tr>
            </thead>
            <tbody>
                {% for unit in unit_scores[:10] %}
                <tr onclick="location.href='/admin/assessment/{{ unit.assessment_id }}/detailed'">
                    <td>
                        <div class="unit-name">
                            {{ unit.name }}
                            {% if unit.has_leader_gap %}<span class="indicator gap" title="Stort gap mellem leder og medarbejdere">GAP</span>{% endif %}
                            {% if unit.has_substitution %}<span class="indicator substitution" title="Substitutionsadfærd">SUBST</span>{% endif %}
                        </div>
                        <div class="assessment-name">{{ unit.assessment_name }}</div>
                    </td>
                    <td>{{ unit.total_responses }}</td>
                    {% for field in ['employee_mening', 'employee_tryghed', 'employee_kan', 'employee_besvaer'] %}
                    <td class="score-cell">
                        {% if unit[field] %}
                            {% set score = unit[field] %}
                            {% set score_class = 'low' if score < 2.5 else ('medium' if score < 3.5 else 'high') %}
                            <span class="score-badge {{ score_class }}">{{ "%.1f"|format(score) }}</span>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% if unit_scores|length > 10 %}
    <p style="text-align: center; margin-top: 15px;">
        <a href="/admin/analyser" style="color: #6366f1; text-decoration: none; font-weight: 500;">
            Se alle {{ unit_scores|length }} enheder &rarr;
        </a>
    </p>
    {% endif %}
    {% else %}
    <div class="empty-state">Ingen analysedata endnu</div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function filterByUnit(unitId) {
    if (unitId) {
        window.location.href = '/admin?unit_id=' + unitId;
    } else {
        window.location.href = '/admin';
    }
}

{% if trend_data and trend_data.assessments %}
// Prepare chart data
const assessments = {{ trend_data.assessments | tojson }};
const fields = {{ trend_data.fields | tojson }};

const labels = assessments.map(c => c.date || c.name);

const colors = {
    'MENING': { border: '#8b5cf6', bg: 'rgba(139, 92, 246, 0.1)' },
    'TRYGHED': { border: '#22c55e', bg: 'rgba(34, 197, 94, 0.1)' },
    'KAN': { border: '#3b82f6', bg: 'rgba(59, 130, 246, 0.1)' },
    'BESVÆR': { border: '#ef4444', bg: 'rgba(239, 68, 68, 0.1)' }
};

const datasets = fields.map(field => ({
    label: field,
    data: assessments.map(c => c.scores[field] || null),
    borderColor: colors[field]?.border || '#6b7280',
    backgroundColor: colors[field]?.bg || 'rgba(107, 114, 128, 0.1)',
    borderWidth: 2,
    tension: 0.3,
    fill: false,
    pointRadius: 4,
    pointHoverRadius: 6
}));

const ctx = document.getElementById('trendChart').getContext('2d');
new Chart(ctx, {
    type: 'line',
    data: { labels, datasets },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
            mode: 'index',
            intersect: false
        },
        scales: {
            y: {
                min: 1,
                max: 5,
                ticks: { stepSize: 0.5 },
                title: { display: false }
            },
            x: {
                title: { display: false }
            }
        },
        plugins: {
            legend: {
                position: 'top',
                labels: {
                    usePointStyle: true,
                    boxWidth: 8,
                    font: { size: 11 }
                }
            },
            tooltip: {
                callbacks: {
                    title: function(context) {
                        const idx = context[0].dataIndex;
                        const camp = assessments[idx];
                        return camp.name + (camp.period ? ' (' + camp.period + ')' : '');
                    }
                }
            }
        }
    }
});
{% endif %}
</script>
{% endblock %}
