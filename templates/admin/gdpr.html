{% extends "admin/layout.html" %}

{% block title %}GDPR & Dataoverblik - Friktionskompasset{% endblock %}

{% block extra_css %}
<style>
    .gdpr-header {
        background: linear-gradient(135deg, #1e3a5f 0%, #2d4a6f 100%);
        color: white;
        padding: 30px;
        border-radius: 12px;
        margin-bottom: 25px;
    }
    .gdpr-header h1 {
        margin: 0 0 8px 0;
        font-size: 1.75rem;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .gdpr-header p {
        margin: 0;
        opacity: 0.85;
        font-size: 1rem;
    }
    .gdpr-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: rgba(16, 185, 129, 0.2);
        color: #10b981;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        margin-left: auto;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 15px;
        margin-bottom: 25px;
    }
    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        border: 1px solid #e5e7eb;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .stat-icon {
        font-size: 1.5rem;
        margin-bottom: 8px;
    }
    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: #1f2937;
        line-height: 1.2;
    }
    .stat-label {
        font-size: 0.85rem;
        color: #6b7280;
        margin-top: 4px;
    }

    .section-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        border: 1px solid #e5e7eb;
        margin-bottom: 25px;
        overflow: hidden;
    }
    .section-header {
        padding: 20px 25px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .section-header h2 {
        margin: 0;
        font-size: 1.1rem;
        color: #1f2937;
    }
    .section-header .icon {
        font-size: 1.25rem;
    }
    .section-body {
        padding: 25px;
    }
    .section-subtitle {
        color: #6b7280;
        margin-bottom: 20px;
        font-size: 0.9rem;
    }

    .processor-grid {
        display: grid;
        gap: 12px;
    }
    .processor-card {
        display: grid;
        grid-template-columns: 1fr 2fr 1.5fr 1fr auto;
        gap: 15px;
        padding: 15px 20px;
        background: #f9fafb;
        border-radius: 8px;
        align-items: center;
        font-size: 0.9rem;
    }
    .processor-card:hover {
        background: #f1f5f9;
    }
    .processor-name {
        font-weight: 600;
        color: #1f2937;
    }
    .processor-purpose {
        color: #4b5563;
    }
    .processor-data {
        color: #6b7280;
        font-size: 0.85rem;
    }
    .processor-location {
        display: flex;
        align-items: center;
        gap: 5px;
        color: #059669;
        font-size: 0.85rem;
    }
    .processor-link {
        color: #3b82f6;
        text-decoration: none;
        font-size: 0.85rem;
    }
    .processor-link:hover {
        text-decoration: underline;
    }

    @media (max-width: 900px) {
        .processor-card {
            grid-template-columns: 1fr;
            gap: 8px;
        }
    }

    .retention-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 15px;
    }
    .retention-item {
        background: #f9fafb;
        padding: 18px;
        border-radius: 8px;
        border-left: 3px solid #3b82f6;
    }
    .retention-item strong {
        display: block;
        color: #1f2937;
        margin-bottom: 5px;
    }
    .retention-item p {
        margin: 0;
        color: #6b7280;
        font-size: 0.9rem;
    }

    .compliance-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }
    .compliance-item {
        background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        padding: 18px;
        border-radius: 8px;
        border-left: 3px solid #10b981;
    }
    .compliance-item .check-icon {
        color: #10b981;
        margin-right: 6px;
    }
    .compliance-item strong {
        color: #065f46;
    }
    .compliance-item p {
        margin: 8px 0 0 0;
        color: #047857;
        font-size: 0.85rem;
    }

    .dpo-contact {
        margin-top: 20px;
        padding: 20px;
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 15px;
    }
    .dpo-contact .icon {
        font-size: 2rem;
    }
    .dpo-contact strong {
        display: block;
        color: #1e40af;
        margin-bottom: 4px;
    }
    .dpo-contact a {
        color: #3b82f6;
    }

    .danger-section {
        border: 2px solid #fecaca;
        border-radius: 12px;
        overflow: hidden;
    }
    .danger-section .section-header {
        background: #fef2f2;
        border-bottom-color: #fecaca;
    }
    .danger-section .section-header h2 {
        color: #991b1b;
    }
    .danger-warning {
        background: #fef2f2;
        border: 1px solid #fecaca;
        color: #991b1b;
        padding: 12px 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 0.9rem;
    }

    .customer-table {
        width: 100%;
        border-collapse: collapse;
    }
    .customer-table th {
        text-align: left;
        padding: 12px 15px;
        background: #f9fafb;
        color: #374151;
        font-weight: 600;
        font-size: 0.85rem;
        border-bottom: 2px solid #e5e7eb;
    }
    .customer-table td {
        padding: 15px;
        border-bottom: 1px solid #e5e7eb;
        color: #4b5563;
    }
    .customer-table tr:hover td {
        background: #f9fafb;
    }
    .customer-table .customer-name {
        font-weight: 600;
        color: #1f2937;
    }
    .btn-danger-small {
        background: #dc2626;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s;
    }
    .btn-danger-small:hover {
        background: #b91c1c;
    }

    .data-timeline {
        display: flex;
        gap: 15px;
        margin-top: 15px;
    }
    .timeline-item {
        flex: 1;
        background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        padding: 15px;
        border-radius: 8px;
        text-align: center;
    }
    .timeline-label {
        font-size: 0.8rem;
        color: #047857;
        margin-bottom: 5px;
    }
    .timeline-value {
        font-weight: 600;
        color: #065f46;
    }
</style>
{% endblock %}

{% block content %}
<div class="gdpr-header">
    <h1>
        <span>üîí</span>
        GDPR & Dataoverblik
        <span class="gdpr-badge">‚úì Compliant</span>
    </h1>
    <p>Compliance dashboard for Data Protection Officers</p>
</div>

<!-- Data Statistik -->
{% if is_superadmin %}
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon">üè¢</div>
        <div class="stat-value">{{ stats.customers }}</div>
        <div class="stat-label">Kunder</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">üë§</div>
        <div class="stat-value">{{ stats.users }}</div>
        <div class="stat-label">Brugere</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">üå≥</div>
        <div class="stat-value">{{ stats.units }}</div>
        <div class="stat-label">Organisationer</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">üìã</div>
        <div class="stat-value">{{ stats.assessments }}</div>
        <div class="stat-label">M√•linger</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">üí¨</div>
        <div class="stat-value">{{ stats.responses }}</div>
        <div class="stat-label">Svar</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">üîë</div>
        <div class="stat-value">{{ stats.tokens }}</div>
        <div class="stat-label">Tokens</div>
    </div>
</div>

<div class="data-timeline">
    <div class="timeline-item">
        <div class="timeline-label">√Üldste data</div>
        <div class="timeline-value">{{ stats.oldest_data or 'N/A' }}</div>
    </div>
    <div class="timeline-item">
        <div class="timeline-label">Nyeste data</div>
        <div class="timeline-value">{{ stats.newest_data or 'N/A' }}</div>
    </div>
    {% if stats.situation_assessments > 0 %}
    <div class="timeline-item" style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);">
        <div class="timeline-label" style="color: #1e40af;">Situationsm√•linger</div>
        <div class="timeline-value" style="color: #1e3a8a;">{{ stats.situation_assessments }} m√•linger, {{ stats.situation_responses }} svar</div>
    </div>
    {% endif %}
</div>
{% else %}
<div class="stats-grid" style="max-width: 400px;">
    <div class="stat-card">
        <div class="stat-icon">üå≥</div>
        <div class="stat-value">{{ stats.units }}</div>
        <div class="stat-label">Organisationer</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">üë§</div>
        <div class="stat-value">{{ stats.users }}</div>
        <div class="stat-label">Brugere</div>
    </div>
</div>
{% endif %}

<!-- Underdatabehandlere -->
<div class="section-card" style="margin-top: 25px;">
    <div class="section-header">
        <span class="icon">üîó</span>
        <h2>Underdatabehandlere (Sub-processors)</h2>
    </div>
    <div class="section-body">
        <p class="section-subtitle">
            Disse tjenester behandler data p√• vegne af Friktionskompasset i henhold til databehandleraftaler.
        </p>

        <div class="processor-grid">
            {% for sp in sub_processors %}
            <div class="processor-card">
                <div class="processor-name">{{ sp.name }}</div>
                <div class="processor-purpose">{{ sp.purpose }}</div>
                <div class="processor-data">{{ sp.data_types }}</div>
                <div class="processor-location">üá™üá∫ {{ sp.location }}</div>
                <a href="{{ sp.url }}" target="_blank" rel="noopener" class="processor-link">Privacy ‚Üí</a>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Data Retention -->
<div class="section-card">
    <div class="section-header">
        <span class="icon">üìÖ</span>
        <h2>Dataopbevaring (Retention)</h2>
    </div>
    <div class="section-body">
        <div class="retention-grid">
            <div class="retention-item">
                <strong>üìä M√•ledata (responses)</strong>
                <p>Opbevares indtil kunde anmoder om sletning</p>
            </div>
            <div class="retention-item">
                <strong>üë§ Brugerkonti</strong>
                <p>Opbevares indtil bruger eller admin sletter</p>
            </div>
            <div class="retention-item" id="email-logs-retention">
                <strong>üìß Email logs</strong>
                <p>90 dage, derefter automatisk sletning</p>
                <p style="margin-top: 8px; font-size: 0.85rem; color: #3b82f6;" id="email-logs-stats">
                    <span class="loading-dots">Henter status...</span>
                </p>
            </div>
            <div class="retention-item" id="audit-logs-retention">
                <strong>üìã Audit log</strong>
                <p>1 √•r, derefter automatisk sletning</p>
                <p style="margin-top: 8px; font-size: 0.85rem; color: #3b82f6;" id="audit-logs-stats">
                    <span class="loading-dots">Henter status...</span>
                </p>
            </div>
        </div>

        <!-- Cleanup Status -->
        <div style="margin-top: 25px; padding: 20px; background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-radius: 8px;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                <div>
                    <strong style="color: #1e40af; display: block; margin-bottom: 5px;">üîÑ Automatisk Cleanup Status</strong>
                    <p style="margin: 0; color: #3b82f6; font-size: 0.9rem;" id="cleanup-status-text">
                        <span class="loading-dots">Henter status...</span>
                    </p>
                </div>
                {% if is_superadmin %}
                <button onclick="runManualCleanup()" class="btn-cleanup" id="cleanup-btn">
                    K√∏r cleanup nu
                </button>
                {% endif %}
            </div>
            <div style="font-size: 0.85rem; color: #1e40af;" id="cleanup-details"></div>
        </div>
    </div>
</div>

<!-- Sletning (kun superadmin) -->
{% if is_superadmin and stats.customers_detail %}
<div class="section-card danger-section">
    <div class="section-header">
        <span class="icon">‚ö†Ô∏è</span>
        <h2>Slet kundedata (GDPR Art. 17 - Retten til sletning)</h2>
    </div>
    <div class="section-body">
        <div class="danger-warning">
            <span>‚ö†Ô∏è</span>
            <span>Sletning af kundedata er permanent og kan ikke fortrydes. Alle brugerkonti, organisationer, m√•linger og svar bliver slettet.</span>
        </div>

        <table class="customer-table">
            <thead>
                <tr>
                    <th>Kunde</th>
                    <th>Brugere</th>
                    <th>Organisationer</th>
                    <th>M√•linger</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for customer in stats.customers_detail %}
                <tr>
                    <td class="customer-name">{{ customer.name }}</td>
                    <td>{{ customer.user_count }}</td>
                    <td>{{ customer.unit_count }}</td>
                    <td>{{ customer.assessment_count }}</td>
                    <td>
                        <form method="POST" action="{{ url_for('admin_gdpr_delete_customer', customer_id=customer.id) }}"
                              style="margin: 0;" id="delete-form-{{ customer.id }}">
                            <button type="button" class="btn-danger-small"
                                    onclick="confirmDeleteCustomer('{{ customer.id }}', '{{ customer.name }}', {{ customer.user_count }}, {{ customer.unit_count }}, {{ customer.assessment_count }})">
                                Slet data
                            </button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- DPA - Databehandleraftale -->
{% if stats.customers_detail %}
<div class="section-card" style="border: 2px solid #dbeafe;">
    <div class="section-header" style="background: #eff6ff;">
        <span class="icon">üìÑ</span>
        <h2 style="color: #1e40af;">Databehandleraftale (DPA)</h2>
    </div>
    <div class="section-body">
        <p class="section-subtitle">
            Generer en juridisk bindende databehandleraftale for hver kunde i overensstemmelse med GDPR krav.
        </p>

        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;">
            {% for customer in stats.customers_detail %}
            <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px;">
                <div style="font-weight: 600; color: #1f2937; margin-bottom: 8px;">{{ customer.name }}</div>
                <div style="display: flex; gap: 8px;">
                    <a href="{{ url_for('admin_dpa', customer_id=customer.id) }}"
                       target="_blank"
                       style="flex: 1; background: #3b82f6; color: white; padding: 8px 12px; border-radius: 6px; text-decoration: none; text-align: center; font-size: 0.85rem;">
                        Se DPA ‚Üó
                    </a>
                    <a href="{{ url_for('admin_dpa_pdf', customer_id=customer.id) }}"
                       style="background: #10b981; color: white; padding: 8px 12px; border-radius: 6px; text-decoration: none; font-size: 0.85rem;">
                        PDF
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- Compliance Info -->
<div class="section-card">
    <div class="section-header">
        <span class="icon">‚úÖ</span>
        <h2>Compliance & Sikkerhed</h2>
    </div>
    <div class="section-body">
        <div class="compliance-grid">
            <div class="compliance-item">
                <strong><span class="check-icon">‚úì</span> GDPR Compliant</strong>
                <p>Data behandles i EU (Frankfurt)</p>
            </div>
            <div class="compliance-item">
                <strong><span class="check-icon">‚úì</span> Kryptering</strong>
                <p>TLS 1.3 i transit, AES-256 at rest</p>
            </div>
            <div class="compliance-item">
                <strong><span class="check-icon">‚úì</span> Anonymisering</strong>
                <p>Survey-svar ikke knyttet til individer</p>
            </div>
            <div class="compliance-item">
                <strong><span class="check-icon">‚úì</span> Audit Logging</strong>
                <p>Alle handlinger logges</p>
            </div>
            <div class="compliance-item">
                <strong><span class="check-icon">‚úì</span> Auto-Retention</strong>
                <p>Automatisk sletning af gamle logs</p>
            </div>
        </div>

        <div class="dpo-contact">
            <span class="icon">üì¨</span>
            <div>
                <strong>Kontakt Data Protection Officer</strong>
                <span>For sp√∏rgsm√•l om databeskyttelse: <a href="mailto:dpo@friktionskompasset.dk">dpo@friktionskompasset.dk</a></span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<style>
    .btn-cleanup {
        background: #10b981;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s;
    }
    .btn-cleanup:hover {
        background: #059669;
    }
    .btn-cleanup:disabled {
        background: #9ca3af;
        cursor: not-allowed;
    }
    .loading-dots::after {
        content: '...';
        animation: dots 1.5s steps(4, end) infinite;
    }
    @keyframes dots {
        0%, 20% { content: '.'; }
        40% { content: '..'; }
        60%, 100% { content: '...'; }
    }
</style>
<script>
async function confirmDeleteCustomer(customerId, customerName, userCount, unitCount, assessmentCount) {
    const confirmed = await ModalUtils.confirmWithInput({
        title: 'Slet kundedata permanent',
        message: `Du er ved at slette <strong>AL data</strong> for <strong>${customerName}</strong>.<br><br>
                  Dette inkluderer:<br>
                  ‚Ä¢ ${userCount} bruger${userCount !== 1 ? 'e' : ''}<br>
                  ‚Ä¢ ${unitCount} organisation${unitCount !== 1 ? 'er' : ''}<br>
                  ‚Ä¢ ${assessmentCount} m√•ling${assessmentCount !== 1 ? 'er' : ''} og alle tilh√∏rende svar<br><br>
                  <strong>Dette kan IKKE fortrydes!</strong>`,
        confirmText: customerName,
        confirmLabel: 'Skriv kundenavnet for at bekr√¶fte sletning',
        confirmButton: 'Slet permanent',
        cancelButton: 'Annuller',
        danger: true
    });

    if (confirmed) {
        document.getElementById('delete-form-' + customerId).submit();
    }
}

// Load cleanup status on page load
async function loadCleanupStatus() {
    try {
        const response = await fetch('/admin/cleanup-status');
        const data = await response.json();

        // Update email logs stats
        if (data.email_logs) {
            const el = data.email_logs;
            document.getElementById('email-logs-stats').innerHTML =
                `${el.total} logs (${el.eligible_for_cleanup} kan slettes)`;
        }

        // Update audit logs stats
        if (data.audit_log) {
            const al = data.audit_log;
            document.getElementById('audit-logs-stats').innerHTML =
                `${al.total} logs (${al.eligible_for_cleanup} kan slettes)`;
        }

        // Update cleanup status
        const lastRun = data.last_cleanup_run;
        if (lastRun && lastRun.found) {
            const runDate = new Date(lastRun.last_run);
            const now = new Date();
            const daysSince = Math.floor((now - runDate) / (1000 * 60 * 60 * 24));

            document.getElementById('cleanup-status-text').innerHTML =
                `Sidste cleanup: ${runDate.toLocaleDateString('da-DK')} (${daysSince} dage siden)`;

            document.getElementById('cleanup-details').innerHTML =
                lastRun.details || '';
        } else {
            document.getElementById('cleanup-status-text').innerHTML =
                'Ingen cleanup er k√∏rt endnu. N√¶ste cleanup k√∏rer kl. 03:00.';
        }

    } catch (error) {
        console.error('Error loading cleanup status:', error);
        document.getElementById('cleanup-status-text').innerHTML =
            'Kunne ikke hente status (fejl: ' + error.message + ')';
    }
}

// Run manual cleanup
async function runManualCleanup() {
    const btn = document.getElementById('cleanup-btn');
    const originalText = btn.textContent;

    if (!confirm('K√∏r manuel cleanup nu? Dette sletter email logs √¶ldre end 90 dage og audit logs √¶ldre end 1 √•r.')) {
        return;
    }

    btn.disabled = true;
    btn.textContent = 'K√∏rer cleanup...';

    try {
        const response = await fetch('/admin/cleanup-run', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();

        if (data.error) {
            alert('Fejl: ' + data.error);
        } else {
            alert(`Cleanup fuldf√∏rt!\n\nEmail logs slettet: ${data.email_logs.deleted}\nAudit logs slettet: ${data.audit_log.deleted}\nTotal: ${data.total_deleted} records`);

            // Reload status
            await loadCleanupStatus();
        }

    } catch (error) {
        alert('Fejl ved cleanup: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.textContent = originalText;
    }
}

// Load status on page load
document.addEventListener('DOMContentLoaded', function() {
    loadCleanupStatus();
});
</script>
{% endblock %}
