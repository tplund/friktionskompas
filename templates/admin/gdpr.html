{% extends "admin/layout.html" %}

{% block title %}GDPR & Dataoverblik - Friktionskompasset{% endblock %}

{% block content %}
<div class="page-header">
    <h1>GDPR & Dataoverblik</h1>
    <p>Compliance dashboard for Data Protection Officers</p>
</div>

<!-- Data Statistik -->
<div class="card" style="margin-bottom: 20px;">
    <h2>Dataoversigt</h2>

    {% if is_superadmin %}
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; text-align: center;">
            <div style="font-size: 2rem; font-weight: bold; color: #3b82f6;">{{ stats.customers }}</div>
            <div style="color: #6b7280;">Kunder</div>
        </div>
        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; text-align: center;">
            <div style="font-size: 2rem; font-weight: bold; color: #3b82f6;">{{ stats.users }}</div>
            <div style="color: #6b7280;">Brugere</div>
        </div>
        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; text-align: center;">
            <div style="font-size: 2rem; font-weight: bold; color: #3b82f6;">{{ stats.units }}</div>
            <div style="color: #6b7280;">Organisationer</div>
        </div>
        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; text-align: center;">
            <div style="font-size: 2rem; font-weight: bold; color: #3b82f6;">{{ stats.assessments }}</div>
            <div style="color: #6b7280;">Målinger</div>
        </div>
        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; text-align: center;">
            <div style="font-size: 2rem; font-weight: bold; color: #3b82f6;">{{ stats.responses }}</div>
            <div style="color: #6b7280;">Svar</div>
        </div>
        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; text-align: center;">
            <div style="font-size: 2rem; font-weight: bold; color: #3b82f6;">{{ stats.tokens }}</div>
            <div style="color: #6b7280;">Tokens</div>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
        <div style="background: #f0fdf4; padding: 15px; border-radius: 8px;">
            <strong>Ældste data:</strong> {{ stats.oldest_data }}
        </div>
        <div style="background: #f0fdf4; padding: 15px; border-radius: 8px;">
            <strong>Nyeste data:</strong> {{ stats.newest_data }}
        </div>
    </div>

    {% if stats.situation_assessments > 0 %}
    <div style="background: #eff6ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <strong>Situationsmålinger:</strong> {{ stats.situation_assessments }} målinger, {{ stats.situation_responses }} svar
    </div>
    {% endif %}

    {% else %}
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; text-align: center;">
            <div style="font-size: 2rem; font-weight: bold; color: #3b82f6;">{{ stats.units }}</div>
            <div style="color: #6b7280;">Organisationer</div>
        </div>
        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; text-align: center;">
            <div style="font-size: 2rem; font-weight: bold; color: #3b82f6;">{{ stats.users }}</div>
            <div style="color: #6b7280;">Brugere</div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Underdatabehandlere -->
<div class="card" style="margin-bottom: 20px;">
    <h2>Underdatabehandlere (Sub-processors)</h2>
    <p style="color: #6b7280; margin-bottom: 15px;">
        Disse tjenester behandler data på vegne af Friktionskompasset.
    </p>

    <table class="data-table">
        <thead>
            <tr>
                <th>Tjeneste</th>
                <th>Formål</th>
                <th>Datatyper</th>
                <th>Lokation</th>
                <th>Privacy</th>
            </tr>
        </thead>
        <tbody>
            {% for sp in sub_processors %}
            <tr>
                <td><strong>{{ sp.name }}</strong></td>
                <td>{{ sp.purpose }}</td>
                <td>{{ sp.data_types }}</td>
                <td>{{ sp.location }}</td>
                <td><a href="{{ sp.url }}" target="_blank" rel="noopener">Link</a></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Data Retention -->
<div class="card" style="margin-bottom: 20px;">
    <h2>Dataopbevaring (Retention)</h2>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
        <div style="background: #f8fafc; padding: 15px; border-radius: 8px;">
            <strong>Måledata (responses)</strong>
            <p style="color: #6b7280; margin: 5px 0 0 0;">Opbevares indtil kunde anmoder om sletning</p>
        </div>
        <div style="background: #f8fafc; padding: 15px; border-radius: 8px;">
            <strong>Brugerkonti</strong>
            <p style="color: #6b7280; margin: 5px 0 0 0;">Opbevares indtil bruger eller admin sletter</p>
        </div>
        <div style="background: #f8fafc; padding: 15px; border-radius: 8px;">
            <strong>Email logs</strong>
            <p style="color: #6b7280; margin: 5px 0 0 0;">90 dage, derefter automatisk sletning</p>
        </div>
        <div style="background: #f8fafc; padding: 15px; border-radius: 8px;">
            <strong>Audit log</strong>
            <p style="color: #6b7280; margin: 5px 0 0 0;">1 år, derefter automatisk sletning</p>
        </div>
    </div>
</div>

<!-- Sletning (kun superadmin) -->
{% if is_superadmin and stats.customers_detail %}
<div class="card" style="margin-bottom: 20px;">
    <h2>Slet kundedata (GDPR Art. 17)</h2>
    <p style="color: #6b7280; margin-bottom: 15px;">
        Slet al data for en kunde. <strong style="color: #dc2626;">Dette kan ikke fortrydes!</strong>
    </p>

    <table class="data-table">
        <thead>
            <tr>
                <th>Kunde</th>
                <th>Brugere</th>
                <th>Organisationer</th>
                <th>Målinger</th>
                <th>Handling</th>
            </tr>
        </thead>
        <tbody>
            {% for customer in stats.customers_detail %}
            <tr>
                <td><strong>{{ customer.name }}</strong></td>
                <td>{{ customer.user_count }}</td>
                <td>{{ customer.unit_count }}</td>
                <td>{{ customer.assessment_count }}</td>
                <td>
                    <form method="POST" action="{{ url_for('admin_gdpr_delete_customer', customer_id=customer.id) }}"
                          style="margin: 0;"
                          onsubmit="return confirm('ADVARSEL: Du er ved at slette AL data for {{ customer.name }}.\n\nDette inkluderer:\n- Alle brugere\n- Alle organisationer\n- Alle målinger og svar\n\nDette kan IKKE fortrydes!\n\nSkriv kundens navn for at bekræfte:') && prompt('Skriv kundenavnet for at bekræfte sletning:') === '{{ customer.name }}';">
                        <button type="submit" class="btn btn-danger btn-small">Slet al data</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<!-- Compliance Info -->
<div class="card">
    <h2>Compliance Information</h2>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
        <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; border-left: 4px solid #10b981;">
            <strong>GDPR Compliant</strong>
            <p style="color: #6b7280; margin: 5px 0 0 0;">Data behandles i EU (Frankfurt)</p>
        </div>
        <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; border-left: 4px solid #10b981;">
            <strong>Kryptering</strong>
            <p style="color: #6b7280; margin: 5px 0 0 0;">TLS 1.3 for data i transit, AES-256 at rest</p>
        </div>
        <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; border-left: 4px solid #10b981;">
            <strong>Anonymisering</strong>
            <p style="color: #6b7280; margin: 5px 0 0 0;">Survey-svar er ikke knyttet til individer</p>
        </div>
        <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; border-left: 4px solid #10b981;">
            <strong>Audit Logging</strong>
            <p style="color: #6b7280; margin: 5px 0 0 0;">Alle sletninger logges</p>
        </div>
    </div>

    <div style="margin-top: 20px; padding: 15px; background: #eff6ff; border-radius: 8px;">
        <strong>Kontakt DPO:</strong>
        <p style="margin: 5px 0 0 0;">
            For spørgsmål om databeskyttelse, kontakt <a href="mailto:dpo@friktionskompasset.dk">dpo@friktionskompasset.dk</a>
        </p>
    </div>
</div>
{% endblock %}
