{% macro render_tree_node(unit, units) %}
{% set level = (unit.full_path.split('//')|length - 1) if unit.full_path else 0 %}
<div class="tree-node level-{{ level }}" data-unit-id="{{ unit.id }}" data-parent-id="{{ unit.parent_id or '' }}" data-level="{{ level }}" data-child-count="{{ unit.child_count or 0 }}" data-name="{{ unit.name }}">
    <div class="tree-node-header">
        <div style="display: flex; align-items: center; flex: 1;">
            <input type="checkbox" class="unit-checkbox" data-unit-id="{{ unit.id }}" onchange="updateSelectedCount()">
            {% if unit.child_count and unit.child_count > 0 %}
            <span class="toggle-btn" onclick="toggleChildren('{{ unit.id }}')">&#9660;</span>
            {% else %}
            <span style="margin-right: 20px;"></span>
            {% endif %}
            <div>
                <div class="tree-node-title">
                    {{ unit.name }}
                    {% if (unit.child_count or 0) == 0 and (unit.total_employees or unit.employee_count or 0) == 0 %}
                    <span class="tag-empty">{{ t('org.empty') }}</span>
                    {% endif %}
                </div>
                <div class="tree-node-meta">
                    {{ unit.total_employees or unit.employee_count or 0 }} {{ t('org.employees') }}
                    {% if unit.child_count and unit.child_count > 0 %}
                        &middot; {{ unit.child_count }} {{ t('org.subunits') }}
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="tree-node-actions">
            <button onclick="confirmDelete('{{ unit.id }}', '{{ unit.name }}')" class="btn-delete" title="{{ t('btn.delete') }}">{{ t('btn.delete') }}</button>
            <a href="/admin/unit/new?parent={{ unit.id }}" class="btn-create" title="{{ t('org.create') }}">+</a>
            <a href="/admin/unit/{{ unit.id }}" class="btn-detail">{{ t('org.details') }}</a>
        </div>
    </div>
</div>

{# Recursively render children #}
{% if unit.child_count > 0 %}
    {% for child_unit in units %}
        {% if child_unit.parent_id == unit.id %}
            {{ render_tree_node(child_unit, units) }}
        {% endif %}
    {% endfor %}
{% endif %}
{% endmacro %}

{# Call macro if this is being included directly #}
{% if unit is defined %}
    {{ render_tree_node(unit, units) }}
{% endif %}
