{% extends "admin/layout.html" %}

{% block title %}Audit Log{% endblock %}

{% block extra_css %}
<style>
    .page-header {
        background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        color: white;
        padding: 30px;
        border-radius: 12px;
        margin-bottom: 30px;
    }
    .page-header h1 { margin-bottom: 10px; }
    .page-header p { opacity: 0.9; margin: 0; }

    .filters-card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    .filters-form {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: flex-end;
    }
    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    .filter-group label {
        font-size: 12px;
        font-weight: 600;
        color: #6b7280;
        text-transform: uppercase;
    }
    .filter-group input, .filter-group select {
        padding: 8px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 14px;
    }
    .btn-filter {
        padding: 8px 16px;
        background: #6366f1;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
    }
    .btn-filter:hover { background: #4f46e5; }
    .btn-reset {
        padding: 8px 16px;
        background: #f3f4f6;
        color: #374151;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        text-decoration: none;
    }
    .btn-reset:hover { background: #e5e7eb; }

    .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }
    .summary-card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        text-align: center;
    }
    .summary-card .value {
        font-size: 2rem;
        font-weight: 700;
        color: #374151;
    }
    .summary-card .label {
        font-size: 12px;
        color: #6b7280;
        text-transform: uppercase;
    }

    .log-table-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    .log-table {
        width: 100%;
        border-collapse: collapse;
    }
    .log-table th {
        background: #f9fafb;
        padding: 12px 16px;
        text-align: left;
        font-size: 12px;
        font-weight: 600;
        color: #6b7280;
        text-transform: uppercase;
        border-bottom: 1px solid #e5e7eb;
    }
    .log-table td {
        padding: 12px 16px;
        border-bottom: 1px solid #f3f4f6;
        font-size: 14px;
    }
    .log-table tr:hover { background: #f9fafb; }
    .log-table tr:last-child td { border-bottom: none; }

    .action-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
    }
    .action-login_success { background: #d1fae5; color: #065f46; }
    .action-login_failed { background: #fee2e2; color: #991b1b; }
    .action-logout { background: #e0e7ff; color: #3730a3; }
    .action-impersonate_start { background: #fef3c7; color: #92400e; }
    .action-impersonate_end { background: #fef3c7; color: #92400e; }
    .action-unit_deleted { background: #fee2e2; color: #991b1b; }
    .action-customer_deleted { background: #fee2e2; color: #991b1b; }
    .action-assessment_deleted { background: #fee2e2; color: #991b1b; }
    .action-backup_created { background: #dbeafe; color: #1e40af; }
    .action-backup_restored { background: #fce7f3; color: #9d174d; }
    .action-default { background: #f3f4f6; color: #374151; }

    .timestamp { color: #6b7280; font-size: 13px; }
    .details { color: #6b7280; font-size: 13px; max-width: 300px; }
    .ip-address { font-family: monospace; font-size: 12px; color: #9ca3af; }

    .pagination {
        display: flex;
        justify-content: center;
        gap: 5px;
        padding: 20px;
    }
    .pagination a, .pagination span {
        padding: 8px 12px;
        border-radius: 6px;
        text-decoration: none;
        font-size: 14px;
    }
    .pagination a {
        background: #f3f4f6;
        color: #374151;
    }
    .pagination a:hover { background: #e5e7eb; }
    .pagination .current {
        background: #6366f1;
        color: white;
    }
    .pagination .disabled {
        color: #9ca3af;
        cursor: not-allowed;
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6b7280;
    }
    .empty-state .icon { font-size: 3rem; margin-bottom: 15px; }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>ðŸ“‹ Audit Log</h1>
    <p>Oversigt over vigtige handlinger i systemet</p>
</div>

<div class="filters-card">
    <form class="filters-form" method="GET">
        <div class="filter-group">
            <label>Handling</label>
            <select name="action">
                <option value="">Alle handlinger</option>
                <option value="login_success" {% if filters.action == 'login_success' %}selected{% endif %}>Login (success)</option>
                <option value="login_failed" {% if filters.action == 'login_failed' %}selected{% endif %}>Login (fejlet)</option>
                <option value="logout" {% if filters.action == 'logout' %}selected{% endif %}>Logout</option>
                <option value="impersonate_start" {% if filters.action == 'impersonate_start' %}selected{% endif %}>Impersonate start</option>
                <option value="impersonate_end" {% if filters.action == 'impersonate_end' %}selected{% endif %}>Impersonate slut</option>
                <option value="unit_deleted" {% if filters.action == 'unit_deleted' %}selected{% endif %}>Enhed slettet</option>
                <option value="customer_deleted" {% if filters.action == 'customer_deleted' %}selected{% endif %}>Kunde slettet</option>
                <option value="assessment_deleted" {% if filters.action == 'assessment_deleted' %}selected{% endif %}>MÃ¥ling slettet</option>
                <option value="backup_created" {% if filters.action == 'backup_created' %}selected{% endif %}>Backup oprettet</option>
                <option value="backup_restored" {% if filters.action == 'backup_restored' %}selected{% endif %}>Backup gendannet</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Fra dato</label>
            <input type="date" name="start_date" value="{{ filters.start_date or '' }}">
        </div>
        <div class="filter-group">
            <label>Til dato</label>
            <input type="date" name="end_date" value="{{ filters.end_date or '' }}">
        </div>
        <button type="submit" class="btn-filter">Filtrer</button>
        <a href="{{ url_for('audit_log_page') }}" class="btn-reset">Nulstil</a>
    </form>
</div>

{% if summary %}
<div class="summary-cards">
    <div class="summary-card">
        <div class="value">{{ summary.get('login_success', 0) }}</div>
        <div class="label">Logins (30 dage)</div>
    </div>
    <div class="summary-card">
        <div class="value">{{ summary.get('login_failed', 0) }}</div>
        <div class="label">Fejlede logins</div>
    </div>
    <div class="summary-card">
        <div class="value">{{ summary.get('impersonate_start', 0) }}</div>
        <div class="label">Impersonations</div>
    </div>
    <div class="summary-card">
        <div class="value">{{ (summary.get('unit_deleted', 0) + summary.get('customer_deleted', 0) + summary.get('assessment_deleted', 0)) }}</div>
        <div class="label">Sletninger</div>
    </div>
</div>
{% endif %}

<div class="log-table-card">
    {% if logs %}
    <table class="log-table">
        <thead>
            <tr>
                <th>Tidspunkt</th>
                <th>Bruger</th>
                <th>Handling</th>
                <th>Detaljer</th>
                <th>IP</th>
            </tr>
        </thead>
        <tbody>
            {% for log in logs %}
            <tr>
                <td class="timestamp">{{ log.timestamp[:19] }}</td>
                <td>{{ log.username or '-' }}</td>
                <td>
                    <span class="action-badge action-{{ log.action }}">
                        {{ log.action | replace('_', ' ') | title }}
                    </span>
                </td>
                <td class="details">{{ log.details or '-' }}</td>
                <td class="ip-address">{{ log.ip_address or '-' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    {% if total_pages > 1 %}
    <div class="pagination">
        {% if page > 1 %}
        <a href="?page={{ page - 1 }}&action={{ filters.action or '' }}&start_date={{ filters.start_date or '' }}&end_date={{ filters.end_date or '' }}">Â« Forrige</a>
        {% endif %}

        {% for p in range(1, total_pages + 1) %}
            {% if p == page %}
            <span class="current">{{ p }}</span>
            {% elif p <= 3 or p > total_pages - 2 or (p >= page - 1 and p <= page + 1) %}
            <a href="?page={{ p }}&action={{ filters.action or '' }}&start_date={{ filters.start_date or '' }}&end_date={{ filters.end_date or '' }}">{{ p }}</a>
            {% elif p == 4 or p == total_pages - 2 %}
            <span class="disabled">...</span>
            {% endif %}
        {% endfor %}

        {% if page < total_pages %}
        <a href="?page={{ page + 1 }}&action={{ filters.action or '' }}&start_date={{ filters.start_date or '' }}&end_date={{ filters.end_date or '' }}">NÃ¦ste Â»</a>
        {% endif %}
    </div>
    {% endif %}

    {% else %}
    <div class="empty-state">
        <div class="icon">ðŸ“‹</div>
        <h3>Ingen log entries</h3>
        <p>Der er ingen handlinger der matcher dine filtre</p>
    </div>
    {% endif %}
</div>
{% endblock %}
